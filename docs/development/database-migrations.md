# Database Migrations

This guide covers database migrations using Alembic in the Telegram Voice2Text Bot project.

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Creating Migrations](#creating-migrations)
- [Applying Migrations](#applying-migrations)
- [Rollback Migrations](#rollback-migrations)
- [Migration Testing](#migration-testing)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)

## Overview

This project uses [Alembic](https://alembic.sqlalchemy.org/) for database schema migrations. Alembic tracks changes to the database schema over time and allows you to:

- Create incremental schema changes
- Apply migrations to bring database up to date
- Rollback changes if needed
- Test migrations before deployment

**Key Files**:
- `alembic.ini` - Alembic configuration
- `alembic/env.py` - Migration environment setup
- `alembic/versions/` - Migration scripts
- `src/storage/models.py` - SQLAlchemy models (source of truth)

## Prerequisites

Before working with migrations:

1. Install dependencies:
   ```bash
   poetry install --with dev
   ```

2. Ensure database URL is configured:
   ```bash
   # In .env file
   DATABASE_URL=sqlite+aiosqlite:///./data/bot.db
   ```

3. Verify Alembic setup:
   ```bash
   poetry run alembic current
   ```

## Creating Migrations

### Automatic Migration Generation

When you modify `src/storage/models.py`, generate a migration automatically:

```bash
# Generate migration based on model changes
poetry run alembic revision --autogenerate -m "description of changes"
```

**Example**:
```bash
poetry run alembic revision --autogenerate -m "add user_preferences table"
```

This creates a new migration file in `alembic/versions/` with:
- Timestamp-based revision ID
- Upgrade operations (apply changes)
- Downgrade operations (revert changes)

### Manual Migration Creation

For complex changes, create an empty migration and edit manually:

```bash
poetry run alembic revision -m "custom migration description"
```

Edit the generated file in `alembic/versions/`:

```python
def upgrade() -> None:
    """Apply changes."""
    op.create_table(
        'user_preferences',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('user_id', sa.BigInteger(), nullable=False),
        # ... more columns
    )

def downgrade() -> None:
    """Revert changes."""
    op.drop_table('user_preferences')
```

### Review Generated Migration

**Always review autogenerated migrations** before applying:

1. Open the new file in `alembic/versions/`
2. Check `upgrade()` and `downgrade()` functions
3. Verify operations match your intent
4. Add any necessary data migrations
5. Test locally before committing

## Applying Migrations

### Local Development

Apply all pending migrations:

```bash
poetry run alembic upgrade head
```

Apply specific number of migrations:

```bash
# Apply one migration
poetry run alembic upgrade +1

# Apply to specific revision
poetry run alembic upgrade <revision_id>
```

### Production (VPS)

Migrations are applied automatically during deployment via GitHub Actions. The workflow:

1. Pulls latest code (including new migrations)
2. Runs `alembic upgrade head` before starting the bot
3. Verifies migration success
4. If migration fails, rolls back and stops deployment

**Manual application** (if needed):

```bash
# SSH to VPS
ssh user@your-vps

# Navigate to project
cd /opt/telegram-voice2text-bot

# Run migration in Docker container
docker run --rm \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/alembic:/app/alembic \
  -v $(pwd)/alembic.ini:/app/alembic.ini \
  -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
  konstantinbalakin/telegram-voice2text-bot:latest \
  alembic upgrade head
```

## Rollback Migrations

### Rollback One Migration

```bash
poetry run alembic downgrade -1
```

### Rollback to Specific Revision

```bash
poetry run alembic downgrade <revision_id>
```

### Rollback All Migrations

```bash
poetry run alembic downgrade base
```

### Production Rollback

If a migration fails in production, the CI/CD pipeline automatically attempts rollback:

```bash
# Manual rollback on VPS
docker run --rm \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/alembic:/app/alembic \
  -v $(pwd)/alembic.ini:/app/alembic.ini \
  -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
  konstantinbalakin/telegram-voice2text-bot:latest \
  alembic downgrade -1
```

## Migration Testing

### CI/CD Testing

All migrations are automatically tested in CI before deployment:

1. **Fresh database test**: Apply all migrations from scratch
2. **Upgrade/downgrade cycle**: Test rollback compatibility
3. **Application startup**: Verify bot works after migration

See `.github/workflows/build-and-deploy.yml` for details.

### Manual Testing

Test migration locally:

```bash
# 1. Backup current database
cp data/bot.db data/bot.db.backup

# 2. Apply migration
poetry run alembic upgrade head

# 3. Test application
poetry run python -m src.main

# 4. If problems occur, rollback
poetry run alembic downgrade -1
cp data/bot.db.backup data/bot.db
```

### Test Upgrade/Downgrade Cycle

```bash
# Apply migration
poetry run alembic upgrade head

# Get current revision
poetry run alembic current

# Rollback
poetry run alembic downgrade -1

# Upgrade again
poetry run alembic upgrade head
```

## Best Practices

### 1. Model Changes

- **Always modify models first**, then generate migration
- Keep models in sync with migrations
- Test model changes locally before generating migration

### 2. Migration Design

- **One logical change per migration** (e.g., "add user_preferences table")
- **Always provide downgrade()** - migrations must be reversible
- **Test both upgrade and downgrade** before committing
- **Add data migrations carefully** - consider large datasets

### 3. SQLite Considerations

SQLite has limitations. For operations like column renaming, use `batch_alter_table`:

```python
def upgrade() -> None:
    with op.batch_alter_table('users') as batch_op:
        batch_op.alter_column('name', new_column_name='username')
```

### 4. Breaking Changes

For breaking schema changes:

1. **Phase 1**: Add new column (nullable)
2. **Deploy**: Run migration, backfill data
3. **Phase 2**: Make column non-nullable
4. **Deploy**: Run second migration
5. **Phase 3**: Remove old column
6. **Deploy**: Run third migration

### 5. Version Control

- **Commit migrations with code changes** that require them
- **Never edit applied migrations** - create new ones instead
- **Keep migration order** - don't reorder or rename files

## Troubleshooting

### Migration Already Applied

```
ERROR [alembic.runtime.migration] Context impl SQLiteImpl.
ERROR [alembic.runtime.migration] Can't locate revision identified by 'abc123'
```

**Solution**: Check current revision and history:
```bash
poetry run alembic current
poetry run alembic history
```

### Database Out of Date

```
RuntimeError: Database schema mismatch. Current: abc123, HEAD: def456
```

**Solution**: Apply pending migrations:
```bash
poetry run alembic upgrade head
```

### Migration Conflict

If two developers create migrations simultaneously:

```bash
# Pull latest migrations
git pull origin main

# Check history
poetry run alembic history

# If conflicting branches, merge revisions
poetry run alembic merge -m "merge migrations" <rev1> <rev2>
```

### Can't Find Database File

```
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) unable to open database file
```

**Solution**: Ensure data directory exists:
```bash
mkdir -p data
```

### Alembic Can't Import Models

```
ModuleNotFoundError: No module named 'src'
```

**Solution**: Run alembic through Poetry:
```bash
poetry run alembic <command>
```

### Check Migration Status

```bash
# Show current revision
poetry run alembic current

# Show migration history
poetry run alembic history

# Show pending migrations
poetry run alembic heads

# Detailed migration info
poetry run alembic show <revision_id>
```

## Related Documentation

- [Migration Runbook](../deployment/migration-runbook.md) - Production migration procedures
- [VPS Setup](../deployment/vps-setup.md) - VPS deployment and migration setup
- [Architecture](./architecture.md) - Database architecture and design
- [Alembic Documentation](https://alembic.sqlalchemy.org/) - Official Alembic docs
