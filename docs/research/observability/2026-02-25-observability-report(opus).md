  ---
  Архитектура мониторинга для Telegram Voice2Text Bot

  Контекст: что у тебя есть сейчас

  - 367 пользователей, ~157 MAU, активный рост
  - VPS: 2 CPU, 4 GB RAM, 30 GB диск
  - Docker: один контейнер с ботом
  - Мониторинг: ноль — только логи в файлы + данные в SQLite
  - Аналитика: ручные отчёты и Excel-скрипт

  ---
  1. Сравнение 5 вариантов

  Бюджет ресурсов VPS

  Сначала зафиксируем, сколько ресурсов уже занято:

  ┌───────────────────────────┬───────────┬────────────┐
  │         Компонент         │    RAM    │    CPU     │
  ├───────────────────────────┼───────────┼────────────┤
  │ Бот (idle, OpenAI API)    │ ~500 MB   │ ~0.3       │
  ├───────────────────────────┼───────────┼────────────┤
  │ Бот (пик, faster-whisper) │ ~2000 MB  │ ~2.0       │
  ├───────────────────────────┼───────────┼────────────┤
  │ Docker + SQLite + логи    │ ~150 MB   │ —          │
  ├───────────────────────────┼───────────┼────────────┤
  │ Доступно для мониторинга  │ ~1.5-2 GB │ ~0.5-1 CPU │
  └───────────────────────────┴───────────┴────────────┘

  Вариант 1: Prometheus + Grafana (классика)

  Bot (prometheus_client) ──:9090/metrics──> Prometheus ──> Grafana

  ┌─────────────┬───────────────────────────────────────────────────────────────────────┐
  │             │                                                                       │
  ├─────────────┼───────────────────────────────────────────────────────────────────────┤
  │ RAM         │ 460-810 MB                                                            │
  ├─────────────┼───────────────────────────────────────────────────────────────────────┤
  │ Диск        │ 2.4-5.2 GB                                                            │
  ├─────────────┼───────────────────────────────────────────────────────────────────────┤
  │ Контейнеров │ +2                                                                    │
  ├─────────────┼───────────────────────────────────────────────────────────────────────┤
  │ Плюсы       │ Индустриальный стандарт, мощный PromQL, готовые дашборды, pull-модель │
  ├─────────────┼───────────────────────────────────────────────────────────────────────┤
  │ Минусы      │ Нет логов (только метрики), нет трейсинга                             │
  ├─────────────┼───────────────────────────────────────────────────────────────────────┤
  │ Сложность   │ Средняя (2-3 дня)                                                     │
  ├─────────────┼───────────────────────────────────────────────────────────────────────┤
  │ Оценка      │ 8/10                                                                  │
  └─────────────┴───────────────────────────────────────────────────────────────────────┘

  Вариант 2: LGTM Stack (Loki + Grafana + Tempo + Mimir)

  Bot ──метрики──> Mimir, ──логи──> Loki, ──трейсы──> Tempo ──> Grafana

  ┌─────────────┬──────────────────────────────────────────────────────────────────────────┐
  │             │                                                                          │
  ├─────────────┼──────────────────────────────────────────────────────────────────────────┤
  │ RAM         │ 1.2-2.1 GB                                                               │
  ├─────────────┼──────────────────────────────────────────────────────────────────────────┤
  │ Диск        │ 6.2-11.2 GB                                                              │
  ├─────────────┼──────────────────────────────────────────────────────────────────────────┤
  │ Контейнеров │ +4-5                                                                     │
  ├─────────────┼──────────────────────────────────────────────────────────────────────────┤
  │ Плюсы       │ Полная наблюдаемость: метрики + логи + трейсы в одном UI                 │
  ├─────────────┼──────────────────────────────────────────────────────────────────────────┤
  │ Минусы      │ Не влезает в 4 GB RAM вместе с ботом. Трейсинг избыточен для одного бота │
  ├─────────────┼──────────────────────────────────────────────────────────────────────────┤
  │ Сложность   │ Высокая (5-7 дней)                                                       │
  ├─────────────┼──────────────────────────────────────────────────────────────────────────┤
  │ Оценка      │ 4/10 — enterprise-решение для десятков микросервисов                     │
  └─────────────┴──────────────────────────────────────────────────────────────────────────┘

  Вариант 3: Application-level метрики + SQLite (лёгкий)

  Bot ──пишет метрики в SQLite──> Streamlit/FastAPI дашборд

  ┌─────────────┬───────────────────────────────────────────────────────────────────────────────┐
  │             │                                                                               │
  ├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
  │ RAM         │ 30-230 MB                                                                     │
  ├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
  │ Диск        │ 0.05-0.55 GB                                                                  │
  ├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
  │ Контейнеров │ +0-1                                                                          │
  ├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
  │ Плюсы       │ Минимальные ресурсы, данные рядом с SQLite, полный контроль                   │
  ├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
  │ Минусы      │ Нет готовых дашбордов — всё писать с нуля, нет алертинга, собственный техдолг │
  ├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
  │ Сложность   │ Низкая базово / Высокая для полноценного дашборда                             │
  ├─────────────┼───────────────────────────────────────────────────────────────────────────────┤
  │ Оценка      │ 5/10 — допустимо как временное решение                                        │
  └─────────────┴───────────────────────────────────────────────────────────────────────────────┘

  Вариант 4: Prometheus + Grafana + Sentry (гибрид) — РЕКОМЕНДУЕМЫЙ

  Bot (prometheus_client) ──:9090──> Prometheus ──> Grafana ──> Telegram (алерты)
  Bot (sentry-sdk) ──HTTPS──> Sentry Cloud (SaaS, бесплатно)

  ┌─────────────┬─────────────────────────────────────────────────────────────────────────────────────────┐
  │             │                                                                                         │
  ├─────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤
  │ RAM на VPS  │ 480-830 MB                                                                              │
  ├─────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤
  │ Диск        │ 2.4-5.2 GB                                                                              │
  ├─────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤
  │ Контейнеров │ +2 (Sentry — SaaS, 0 ресурсов на VPS)                                                   │
  ├─────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤
  │ Плюсы       │ Sentry бесплатно закрывает ошибки + performance, Grafana — дашборды + алерты в Telegram │
  ├─────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤
  │ Минусы      │ Зависимость от SaaS Sentry, бесплатный план ограничен (5K ошибок/мес)                   │
  ├─────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤
  │ Сложность   │ Средняя (2-3 дня)                                                                       │
  ├─────────────┼─────────────────────────────────────────────────────────────────────────────────────────┤
  │ Оценка      │ 9/10                                                                                    │
  └─────────────┴─────────────────────────────────────────────────────────────────────────────────────────┘

  Вариант 5: OpenTelemetry Collector

  Bot (OTel SDK) ──OTLP──> OTel Collector ──> Prometheus ──> Grafana

  ┌─────────────┬────────────────────────────────────────────────────────────────────────────────────────────────────┐
  │             │                                                                                                    │
  ├─────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ RAM         │ 600-1050 MB                                                                                        │
  ├─────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ Диск        │ 2.3-5.3 GB                                                                                         │
  ├─────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ Контейнеров │ +3                                                                                                 │
  ├─────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ Плюсы       │ Vendor-neutral стандарт, единый SDK для метрик/логов/трейсов                                       │
  ├─────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ Минусы      │ Дополнительный контейнер, OTel Python SDK менее зрелый, для одного бота vendor-neutrality не нужна │
  ├─────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ Сложность   │ Высокая (3-5 дней)                                                                                 │
  ├─────────────┼────────────────────────────────────────────────────────────────────────────────────────────────────┤
  │ Оценка      │ 6/10 — хорошая инвестиция, но overengineering сейчас                                               │
  └─────────────┴────────────────────────────────────────────────────────────────────────────────────────────────────┘

  Сводная таблица

  ┌───────────┬──────────────┬────────────┬─────────────┬──────────────────┬─────────────┐
  │ Критерий  │ Prom+Grafana │    LGTM    │   SQLite    │   Prom+Sentry    │    OTel     │
  ├───────────┼──────────────┼────────────┼─────────────┼──────────────────┼─────────────┤
  │ RAM       │  460-810 MB  │ 1.2-2.1 GB │  30-230 MB  │    480-830 MB    │ 600-1050 MB │
  ├───────────┼──────────────┼────────────┼─────────────┼──────────────────┼─────────────┤
  │ Метрики   │   Отлично    │  Отлично   │ Ограниченно │     Отлично      │   Отлично   │
  ├───────────┼──────────────┼────────────┼─────────────┼──────────────────┼─────────────┤
  │ Ошибки    │    Алерты    │   Алерты   │     Нет     │ Отлично (Sentry) │   Алерты    │
  ├───────────┼──────────────┼────────────┼─────────────┼──────────────────┼─────────────┤
  │ Дашборды  │   Grafana    │  Grafana   │  Свой код   │ Grafana + Sentry │   Grafana   │
  ├───────────┼──────────────┼────────────┼─────────────┼──────────────────┼─────────────┤
  │ Сложность │   Средняя    │  Высокая   │   Низкая    │     Средняя      │   Высокая   │
  ├───────────┼──────────────┼────────────┼─────────────┼──────────────────┼─────────────┤
  │ Итого     │     8/10     │    4/10    │    5/10     │       9/10       │    6/10     │
  └───────────┴──────────────┴────────────┴─────────────┴──────────────────┴─────────────┘

  ---
  2. Рекомендация: Prometheus + Grafana + Sentry

  Почему именно этот вариант

  1. Влезает в RAM: ~500-800 MB при бюджете ~1.5-2 GB — достаточный запас
  2. Sentry бесплатно закрывает самую сложную часть — трекинг ошибок с stack traces, breadcrumbs, performance monitoring
  3. Grafana Alerting умеет отправлять алерты прямо в Telegram — не нужен отдельный Alertmanager
  4. Prometheus — проверенный стек для метрик, PromQL для сложных запросов
  5. Масштабируемость: потом можно добавить Loki для логов, не трогая остальной стек

  Итоговая архитектура

  ┌─────────────────────────────────────────────────────────┐
  │                    VPS (2 CPU, 4 GB RAM)                │
  │                                                         │
  │  Docker Compose                                         │
  │  ┌───────────────────────┐                              │
  │  │  telegram-voice2text   │                              │
  │  │  + prometheus_client   │──:9090/metrics──┐            │
  │  │  + sentry-sdk          │──HTTPS──────────│──> Sentry  │
  │  └───────────────────────┘                  │   Cloud    │
  │                                             │            │
  │  ┌───────────────────────┐                  │            │
  │  │  Prometheus (350 MB)   │<── pull ────────┘            │
  │  │  retention: 15 days    │                              │
  │  │  disk: ~2 GB           │                              │
  │  └───────────────────────┘                               │
  │                                                          │
  │  ┌───────────────────────┐                               │
  │  │  Grafana (200 MB)      │──:3000 (web UI)──> Браузер   │
  │  │  + Telegram alerts     │──webhook──> Telegram Owner    │
  │  └───────────────────────┘                               │
  └──────────────────────────────────────────────────────────┘

  ---
  3. Дизайн метрик

  Технические метрики (реал-тайм)

  ┌──────────────────────────────────────┬───────────┬─────────────────────────┬───────────────────────┐
  │               Метрика                │    Тип    │         Labels          │ Где инструментировать │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ transcription_requests_total         │ Counter   │ provider, model, status │ orchestrator          │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ transcription_duration_seconds       │ Histogram │ provider, model         │ orchestrator          │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ transcription_audio_duration_seconds │ Histogram │ media_type              │ handlers              │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ transcription_fallback_total         │ Counter   │ reason                  │ orchestrator          │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ transcription_queue_size             │ Gauge     │ —                       │ queue_manager         │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ transcription_active_workers         │ Gauge     │ —                       │ queue_manager         │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ llm_requests_total                   │ Counter   │ model, mode, status     │ text_processor        │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ llm_duration_seconds                 │ Histogram │ model, mode             │ text_processor        │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ api_errors_total                     │ Counter   │ service, error_type     │ providers             │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ bot_messages_received_total          │ Counter   │ message_type            │ handlers              │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ bot_callback_queries_total           │ Counter   │ action                  │ callbacks             │
  ├──────────────────────────────────────┼───────────┼─────────────────────────┼───────────────────────┤
  │ bot_errors_total                     │ Counter   │ error_type              │ error_handler         │
  └──────────────────────────────────────┴───────────┴─────────────────────────┴───────────────────────┘

  Бизнес-метрики (из SQLite, каждые 5 минут)

  ┌──────────────────────────────────────┬─────────┬──────────────────────────────┐
  │               Метрика                │   Тип   │           Описание           │
  ├──────────────────────────────────────┼─────────┼──────────────────────────────┤
  │ business_active_users{period}        │ Gauge   │ DAU/WAU/MAU                  │
  ├──────────────────────────────────────┼─────────┼──────────────────────────────┤
  │ business_new_users_total             │ Counter │ Новые регистрации            │
  ├──────────────────────────────────────┼─────────┼──────────────────────────────┤
  │ business_transcriptions_total        │ Counter │ Успешные транскрипции        │
  ├──────────────────────────────────────┼─────────┼──────────────────────────────┤
  │ business_audio_minutes_total         │ Counter │ Аудио-минуты обработанные    │
  ├──────────────────────────────────────┼─────────┼──────────────────────────────┤
  │ business_estimated_cost_rubles_total │ Counter │ Расходы API (руб.)           │
  ├──────────────────────────────────────┼─────────┼──────────────────────────────┤
  │ business_variant_cache_hits_total    │ Counter │ Кэш-попадания (экономия LLM) │
  └──────────────────────────────────────┴─────────┴──────────────────────────────┘

  Подход: Push vs Pull

  Pull (рекомендуется): prometheus_client поднимает HTTP-сервер на порту 9090, Prometheus сам приходит и забирает метрики каждые 15-30 секунд. Бот ничего не знает о Prometheus — идеальная декомпозиция.

  ---
  4. Стратегия алертинга

  Критические (немедленно в Telegram)

  ┌───────────────────────┬───────────────────────────────────────┐
  │         Алерт         │                Условие                │
  ├───────────────────────┼───────────────────────────────────────┤
  │ BotDown               │ Бот не отвечает 2+ минуты             │
  ├───────────────────────┼───────────────────────────────────────┤
  │ HighErrorRate         │ >6 ошибок в минуту (5 мин)            │
  ├───────────────────────┼───────────────────────────────────────┤
  │ TranscriptionFailures │ >20% транскрипций с ошибкой (15 мин)  │
  ├───────────────────────┼───────────────────────────────────────┤
  │ MassFallback          │ >10% транскрипций через base fallback │
  ├───────────────────────┼───────────────────────────────────────┤
  │ QueueOverflow         │ Очередь >8 из 10 (5 мин)              │
  └───────────────────────┴───────────────────────────────────────┘

  Предупреждения (1 раз в час)

  ┌───────────────────┬──────────────────────────┐
  │       Алерт       │         Условие          │
  ├───────────────────┼──────────────────────────┤
  │ HighP95Latency    │ P95 транскрипции >30 сек │
  ├───────────────────┼──────────────────────────┤
  │ HighDailyCost     │ Расходы за день >500 руб │
  ├───────────────────┼──────────────────────────┤
  │ HighMemoryUsage   │ Бот потребляет >3 GB RAM │
  ├───────────────────┼──────────────────────────┤
  │ HighNullModelRate │ Много NULL model events  │
  └───────────────────┴──────────────────────────┘

  Алерты через Grafana Contact Points — встроенная интеграция с Telegram, не нужен отдельный Alertmanager.

  ---
  5. Дорожная карта

  Фаза 1: Quick wins (1-2 дня)

  1. Sentry SDK — 30 минут. uv add sentry-sdk[asyncio], 10 строк в main.py. Мгновенный результат: все ошибки видны с полным контекстом.
  2. prometheus_client — 2-3 часа. Создать src/utils/metrics.py, добавить init_metrics() в main.py.
  3. Инструментировать критический путь — 2-3 часа. Транскрипция, очередь, ошибки, base fallback.

  Фаза 2: Core monitoring (2-3 дня)

  1. Prometheus + Grafana в docker-compose
  2. Операционный дашборд (статус, latency, ошибки, очередь)
  3. Алерты через Grafana → Telegram
  4. Инструментировать оставшиеся компоненты (LLM, кнопки, API)

  Фаза 3: Бизнес-дашборды (2-3 дня)

  1. Periodic metrics collector (DAU/WAU/MAU из SQLite)
  2. Бизнес-дашборд (пользователи, стоимость, engagement, fallback rate)
  3. SLO-дашборд (availability, latency, fallback rate)

  Фаза 4: Продвинутое (по потребности)

  1. Loki для логов (+400-600 MB RAM)
  2. node_exporter для системных метрик (+20 MB RAM)
  3. cAdvisor для Docker-метрик (+50 MB RAM)

  ---
  6. Бюджет ресурсов (Фаза 2)

  ┌────────────────────────────────┬──────────┬───────┬─────────┐
  │           Компонент            │   RAM    │  CPU  │  Диск   │
  ├────────────────────────────────┼──────────┼───────┼─────────┤
  │ Бот (idle)                     │ 500 MB   │ 0.3   │ —       │
  ├────────────────────────────────┼──────────┼───────┼─────────┤
  │ prometheus_client + sentry-sdk │ 30 MB    │ 0.02  │ —       │
  ├────────────────────────────────┼──────────┼───────┼─────────┤
  │ Prometheus                     │ 350 MB   │ 0.15  │ 2 GB    │
  ├────────────────────────────────┼──────────┼───────┼─────────┤
  │ Grafana                        │ 200 MB   │ 0.1   │ 200 MB  │
  ├────────────────────────────────┼──────────┼───────┼─────────┤
  │ Docker + SQLite + логи         │ 150 MB   │ —     │ 1.5 GB  │
  ├────────────────────────────────┼──────────┼───────┼─────────┤
  │ Итого (idle)                   │ ~1.33 GB │ ~0.57 │ ~5.2 GB │
  ├────────────────────────────────┼──────────┼───────┼─────────┤
  │ Запас из 4 GB                  │ 2.67 GB  │ 1.43  │ 24.8 GB │
  └────────────────────────────────┴──────────┴───────┴─────────┘

  Даже при пиковой нагрузке с faster-whisper (~2.83 GB) — остаётся 1.17 GB запаса. Безопасно.

  ---
  Итого

  ┌─────────────────────┬────────────────────────────────────────────────────────────────────┐
  │         Что         │                              Решение                               │
  ├─────────────────────┼────────────────────────────────────────────────────────────────────┤
  │ Стек                │ Prometheus + Grafana + Sentry                                      │
  ├─────────────────────┼────────────────────────────────────────────────────────────────────┤
  │ Не LGTM             │ Не влезает в 4 GB RAM                                              │
  ├─────────────────────┼────────────────────────────────────────────────────────────────────┤
  │ Не OpenTelemetry    │ Overengineering для одного бота                                    │
  ├─────────────────────┼────────────────────────────────────────────────────────────────────┤
  │ Не чистый SQLite    │ Нет готовых дашбордов и алертинга                                  │
  ├─────────────────────┼────────────────────────────────────────────────────────────────────┤
  │ Трудозатраты        │ Фаза 1-2: 3-5 дней, Фаза 3: +2-3 дня                               │
  ├─────────────────────┼────────────────────────────────────────────────────────────────────┤
  │ Файлы для создания  │ src/utils/metrics.py, monitoring/prometheus/, monitoring/grafana/  │
  ├─────────────────────┼────────────────────────────────────────────────────────────────────┤
  │ Файлы для изменения │ main.py, docker-compose.yml, orchestrator, handlers, queue_manager │
  └─────────────────────┴────────────────────────────────────────────────────────────────────┘