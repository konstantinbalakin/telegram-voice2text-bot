name: Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_run:
    workflows: ["Build and Tag"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v0.1.0)'
        required: true
        type: string

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: production
    # Only run if Build and Tag succeeded (for workflow_run) or for other triggers
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to get tags

      - name: Extract version from tag
        id: version
        run: |
          # Get version based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Tag push - extract from GITHUB_REF
            VERSION=${GITHUB_REF#refs/tags/}
            echo "Using tag from push: $VERSION"
          else
            # workflow_run - get latest tag from repository
            echo "Getting latest tag from repository (workflow_run trigger)..."
            git fetch --tags
            VERSION=$(git describe --tags --abbrev=0)
            echo "Found latest tag: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying version: $VERSION"

      - name: Run database migrations on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # Exit on error

            VERSION="${{ steps.version.outputs.version }}"
            echo "üîÑ Starting database migration process for $VERSION..."

            # Navigate to project directory
            cd /opt/telegram-voice2text-bot || exit 1

            # Pull latest code (for migration files and docker-compose updates)
            git fetch --all --tags
            git checkout "$VERSION"

            # Check current migration status
            echo "üìä Current database revision:"
            CURRENT_REV=$(docker run --rm \
              -v $(pwd)/data:/app/data \
              -v $(pwd)/alembic:/app/alembic \
              -v $(pwd)/alembic.ini:/app/alembic.ini \
              -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
              -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
              ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
              alembic current 2>&1 || true)

            echo "$CURRENT_REV"

            # Check if database exists but has no alembic version
            if [ -f "data/bot.db" ] && echo "$CURRENT_REV" | grep -q "Can't locate revision"; then
              echo "‚ö†Ô∏è  Existing database detected without migration history"
              echo "üîñ Stamping database to initial revision 7751fc657749..."

              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic stamp 7751fc657749

              echo "‚úÖ Database stamped to initial revision"
              echo "‚¨ÜÔ∏è  Now applying new migrations..."
            fi

            # Run migrations
            echo "‚¨ÜÔ∏è  Applying migrations..."
            MIGRATION_OUTPUT=$(docker run --rm \
              -v $(pwd)/data:/app/data \
              -v $(pwd)/alembic:/app/alembic \
              -v $(pwd)/alembic.ini:/app/alembic.ini \
              -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
              -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
              ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
              alembic upgrade head 2>&1) || MIGRATION_FAILED=1

            echo "$MIGRATION_OUTPUT"

            if [ -z "$MIGRATION_FAILED" ]; then
              # Success - show new revision
              echo "‚úÖ Migration successful!"
              echo "üìä New database revision:"
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic current

            elif echo "$MIGRATION_OUTPUT" | grep -q "table .* already exists"; then
              # Database has tables but no alembic version - stamp to initial revision
              echo "‚ö†Ô∏è  Tables already exist - stamping database to initial revision 7751fc657749..."

              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic stamp 7751fc657749

              echo "‚úÖ Database stamped to initial revision"
              echo "‚¨ÜÔ∏è  Now applying new migrations..."

              # Try upgrade again
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic upgrade head

              echo "‚úÖ Migration successful!"
              echo "üìä New database revision:"
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic current

            else
              # Real migration failure - attempt rollback
              echo "‚ùå Migration failed with unexpected error!"

              # Try to rollback
              echo "üîÑ Attempting rollback..."
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME}}/telegram-voice2text-bot:$VERSION \
                alembic downgrade -1 2>&1 || echo "Rollback failed (may not be at any revision)"

              echo "‚ùå Deployment aborted due to migration failure"
              exit 1
            fi

  deploy:
    needs: migrate
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to get tags

      - name: Extract version from tag
        id: version
        run: |
          # Get version based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Tag push - extract from GITHUB_REF
            VERSION=${GITHUB_REF#refs/tags/}
            echo "Using tag from push: $VERSION"
          else
            # workflow_run - get latest tag from repository
            echo "Getting latest tag from repository (workflow_run trigger)..."
            git fetch --tags
            VERSION=$(git describe --tags --abbrev=0)
            echo "Found latest tag: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying version: $VERSION"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            VERSION="${{ steps.version.outputs.version }}"
            echo "üöÄ Deploying version $VERSION to production..."

            # Navigate to project directory
            cd /opt/telegram-voice2text-bot || exit 1

            # Ensure we're on the right tag
            git fetch --all --tags
            git checkout "$VERSION"

            # Create .env file with secrets
            cat > .env <<EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            BOT_MODE=polling
            # Client API for support large files
            TELETHON_ENABLED=false
            TELEGRAM_API_ID=${{ secrets.TELEGRAM_API_ID }}
            TELEGRAM_API_HASH=${{ secrets.TELEGRAM_API_HASH }}
            TELETHON_SESSION_NAME=bot_client

            # Transcription Provider Configuration
            WHISPER_PROVIDERS=["faster-whisper"]
            WHISPER_ROUTING_STRATEGY=hybrid #single, fallback, benchmark, hybrid
            PRIMARY_PROVIDER=faster-whisper
            BENCHMARK_MODE=false

            # FasterWhisper Production Configuration (medium/int8/beam1)
            FASTER_WHISPER_MODEL_SIZE=base
            FASTER_WHISPER_DEVICE=cpu
            FASTER_WHISPER_COMPUTE_TYPE=int8
            FASTER_WHISPER_BEAM_SIZE=1
            FASTER_WHISPER_VAD_FILTER=true

            # Whisper (CPU fallback - if needed)
            WHISPER_DEVICE=cpu

            # OpenAI Whisper API Configuration
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            OPENAI_MODEL=whisper-1
            OPENAI_TIMEOUT=60

            # Fallback Configuration
            FALLBACK_PROVIDER=openai
            DURATION_THRESHOLD_SECONDS=30

            # Hybrid Strategy Configuration (disabled in production)
            HYBRID_SHORT_THRESHOLD=0
            HYBRID_DRAFT_PROVIDER=faster-whisper
            HYBRID_DRAFT_MODEL=small
            HYBRID_QUALITY_PROVIDER=faster-whisper
            HYBRID_QUALITY_MODEL=small

            # LLM Text Refinement (disabled in production)
            LLM_REFINEMENT_ENABLED=true
            LLM_PROVIDER=deepseek
            LLM_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            LLM_MODEL=deepseek-chat
            LLM_BASE_URL=https://api.deepseek.com
            LLM_REFINEMENT_PROMPT=–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥—ë–Ω —Ç–µ–∫—Å—Ç –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–∏. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–≤–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º–∏. –ï—Å–ª–∏ —Å–ª–æ–≤–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ, —Ç–æ –Ω–µ –Ω—É–∂–Ω–æ –µ–≥–æ –∏–∑–º–µ–Ω—è—Ç—å. –ê –µ—Å–ª–∏ –Ω–µ –æ—á–µ–Ω—å, —Ç–æ –ø–æ–ø—Ä–æ–±—É–π –ø–æ–¥–æ–±—Ä–∞—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ —Å–º—ã—Å–ª—É –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –∏—Ç–æ–≥–æ–≤—ã–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º. –ë–µ–∑ –¥—Ä—É–≥–æ–≥–æ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞. –í–æ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:
            LLM_TIMEOUT=60
            LLM_DEBUG_MODE=false

            # Audio Preprocessing
            AUDIO_CONVERT_TO_MONO=true
            AUDIO_TARGET_SAMPLE_RATE=16000
            AUDIO_SPEED_MULTIPLIER=1.7

            # Database
            DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db

            # Logging
            LOG_LEVEL=INFO
            LOG_DIR=./logs

            # Processing
            MAX_QUEUE_SIZE=1
            MAX_CONCURRENT_WORKERS=1
            MAX_VOICE_DURATION_SECONDS=10800
            TRANSCRIPTION_TIMEOUT=10800
            PROGRESS_RTF=0.15
            PROGRESS_UPDATE_INTERVAL=5

            # Quota
            DEFAULT_DAILY_QUOTA_SECONDS=60

            # Application Version (for centralized logging)
            APP_VERSION=$VERSION

            # Optional: Remote Syslog Configuration
            # Uncomment and configure if using remote log aggregation
            # SYSLOG_ENABLED=false
            # SYSLOG_HOST=logs.example.com
            # SYSLOG_PORT=514
            EOF

            # Pull Docker image with version tag
            docker pull ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION

            # Tag as latest
            docker tag ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                       ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:latest

            # Update IMAGE_NAME in .env for docker-compose
            echo "IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION" >> .env

            # Create required directories (if not exist)
            mkdir -p data logs

            # Set permissions for appuser inside container (UID 1000)
            chown -R 1000:1000 data logs

            # Rolling update with zero downtime
            docker compose -f docker-compose.prod.yml up -d --no-deps bot

            # Wait for container to be healthy
            echo "‚è≥ Waiting for health check..."
            sleep 15

            # Check if container is healthy
            CONTAINER_STATUS=$(docker inspect --format='{{.State.Health.Status}}' telegram-voice2text-bot 2>/dev/null || echo "unknown")

            if [ "$CONTAINER_STATUS" != "healthy" ] && [ "$CONTAINER_STATUS" != "unknown" ]; then
              echo "‚ùå Health check failed! Container status: $CONTAINER_STATUS"
              docker compose -f docker-compose.prod.yml logs --tail=50 bot
              exit 1
            fi

            # Show status
            echo "‚úÖ Deployment successful! Version $VERSION is now live."
            docker compose -f docker-compose.prod.yml ps

            # Cleanup old images (keep last 3 versions)
            echo "üßπ Cleaning up old Docker images..."
            docker images ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +4 | awk '{print $1}' | xargs -r docker rmi || true

            echo "üéâ Deployment complete!"
