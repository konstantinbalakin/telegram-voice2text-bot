name: Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_run:
    workflows: ["Build and Tag"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v0.1.0)'
        required: true
        type: string

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: production
    # Only run if Build and Tag succeeded (for workflow_run) or for other triggers
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to get tags

      - name: Extract version from tag
        id: version
        run: |
          # Get version based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Tag push - extract from GITHUB_REF
            VERSION=${GITHUB_REF#refs/tags/}
            echo "Using tag from push: $VERSION"
          else
            # workflow_run - get latest tag from repository
            echo "Getting latest tag from repository (workflow_run trigger)..."
            git fetch --tags
            VERSION=$(git describe --tags --abbrev=0)
            echo "Found latest tag: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying version: $VERSION"

      - name: Run database migrations on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # Exit on error

            VERSION="${{ steps.version.outputs.version }}"
            echo "üîÑ Starting database migration process for $VERSION..."

            # Navigate to project directory
            cd /opt/telegram-voice2text-bot || exit 1

            # Pull latest code (for migration files and docker-compose updates)
            git fetch --all --tags
            git checkout "$VERSION"

            # Check current migration status
            echo "üìä Current database revision:"
            CURRENT_REV=$(docker run --rm \
              -v $(pwd)/data:/app/data \
              -v $(pwd)/alembic:/app/alembic \
              -v $(pwd)/alembic.ini:/app/alembic.ini \
              -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
              -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
              ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
              alembic current 2>&1 || true)

            echo "$CURRENT_REV"

            # Check if database exists but has no alembic version
            if [ -f "data/bot.db" ] && echo "$CURRENT_REV" | grep -q "Can't locate revision"; then
              echo "‚ö†Ô∏è  Existing database detected without migration history"
              echo "üîñ Stamping database to initial revision 7751fc657749..."

              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic stamp 7751fc657749

              echo "‚úÖ Database stamped to initial revision"
              echo "‚¨ÜÔ∏è  Now applying new migrations..."
            fi

            # Run migrations
            echo "‚¨ÜÔ∏è  Applying migrations..."
            MIGRATION_OUTPUT=$(docker run --rm \
              -v $(pwd)/data:/app/data \
              -v $(pwd)/alembic:/app/alembic \
              -v $(pwd)/alembic.ini:/app/alembic.ini \
              -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
              -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
              ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
              alembic upgrade head 2>&1) || MIGRATION_FAILED=1

            echo "$MIGRATION_OUTPUT"

            if [ -z "$MIGRATION_FAILED" ]; then
              # Success - show new revision
              echo "‚úÖ Migration successful!"
              echo "üìä New database revision:"
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic current

            elif echo "$MIGRATION_OUTPUT" | grep -q "table .* already exists"; then
              # Database has tables but no alembic version - stamp to initial revision
              echo "‚ö†Ô∏è  Tables already exist - stamping database to initial revision 7751fc657749..."

              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic stamp 7751fc657749

              echo "‚úÖ Database stamped to initial revision"
              echo "‚¨ÜÔ∏è  Now applying new migrations..."

              # Try upgrade again
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic upgrade head

              echo "‚úÖ Migration successful!"
              echo "üìä New database revision:"
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                alembic current

            else
              # Real migration failure - attempt rollback
              echo "‚ùå Migration failed with unexpected error!"

              # Try to rollback
              echo "üîÑ Attempting rollback..."
              docker run --rm \
                -v $(pwd)/data:/app/data \
                -v $(pwd)/alembic:/app/alembic \
                -v $(pwd)/alembic.ini:/app/alembic.ini \
                -e DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db \
                -e TELEGRAM_BOT_TOKEN=test_token_for_migrations \
                ${{ secrets.DOCKER_USERNAME}}/telegram-voice2text-bot:$VERSION \
                alembic downgrade -1 2>&1 || echo "Rollback failed (may not be at any revision)"

              echo "‚ùå Deployment aborted due to migration failure"
              exit 1
            fi

  deploy:
    needs: migrate
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to get tags

      - name: Extract version from tag
        id: version
        run: |
          # Get version based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual version: $VERSION"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Tag push - extract from GITHUB_REF
            VERSION=${GITHUB_REF#refs/tags/}
            echo "Using tag from push: $VERSION"
          else
            # workflow_run - get latest tag from repository
            echo "Getting latest tag from repository (workflow_run trigger)..."
            git fetch --tags
            VERSION=$(git describe --tags --abbrev=0)
            echo "Found latest tag: $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying version: $VERSION"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            VERSION="${{ steps.version.outputs.version }}"
            echo "üöÄ Deploying version $VERSION to production..."

            # Navigate to project directory
            cd /opt/telegram-voice2text-bot || exit 1

            # Ensure we're on the right tag
            git fetch --all --tags
            git checkout "$VERSION"
            
            # Create .env file with secrets
            cat > .env <<EOF
            #API tokens and keys
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            TELEGRAM_API_ID=${{ secrets.TELEGRAM_API_ID }}
            TELEGRAM_API_HASH=${{ secrets.TELEGRAM_API_HASH }}
            LLM_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}
            BOT_MODE=polling
            TELEGRAM_TIMEOUT=30
            
            # Client API for support large files
            TELETHON_ENABLED=true
            TELETHON_SESSION_NAME=bot_client

            # Transcription Provider Configuration
            WHISPER_PROVIDERS=["openai", "faster-whisper"] #["faster-whisper", "whisper", "openai"]
            WHISPER_ROUTING_STRATEGY=structure #single, fallback, benchmark, hybrid, structure
            PRIMARY_PROVIDER=openai
            BENCHMARK_MODE=false

            # FasterWhisper Production Configuration (medium/int8/beam1)
            FASTER_WHISPER_MODEL_SIZE=base #tiny, base, small, medium, large-v2, large-v3
            FASTER_WHISPER_DEVICE=cpu
            FASTER_WHISPER_COMPUTE_TYPE=int8 #int8, float32
            FASTER_WHISPER_BEAM_SIZE=1
            FASTER_WHISPER_VAD_FILTER=true

            # Whisper (CPU fallback - if needed)
            WHISPER_DEVICE=cpu

            # OpenAI Whisper API Configuration
            OPENAI_MODEL=gpt-4o-transcribe #whisper-1, gpt-4o-transcribe, gpt-4o-mini-transcribe
            OPENAI_TIMEOUT=90
            OPENAI_4O_TRANSCRIBE_PREFERRED_FORMAT=mp3 #mp3, wav (for gpt-4o-* models)

            # OpenAI Long Audio Handling
            OPENAI_GPT4O_MAX_DURATION=420 #default: 420s (7 min)
            OPENAI_CHANGE_MODEL=false #default: True. –ú–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å false, –µ—Å–ª–∏ OPENAI_CHUNKING=true
            OPENAI_CHUNKING=true #default: False
            OPENAI_CHUNK_SIZE_SECONDS=420 #default: 420 (7 min)
            OPENAI_CHUNK_OVERLAP_SECONDS=2 #default: 2s
            OPENAI_PARALLEL_CHUNKS=true #default: True
            OPENAI_MAX_PARALLEL_CHUNKS=8 #default: 8

            # Fallback Configuration
            FALLBACK_PROVIDER=openai
            DURATION_THRESHOLD_SECONDS=30

            # Hybrid Strategy Configuration
            HYBRID_SHORT_THRESHOLD=0
            HYBRID_DRAFT_PROVIDER=faster-whisper
            HYBRID_DRAFT_MODEL=small #tiny, base, small
            HYBRID_QUALITY_PROVIDER=openai # openai, faster-whisper
            HYBRID_QUALITY_MODEL=gpt-4o-transcribe # whisper-1, gpt-4o-transcribe, medium

            # Structure Strategy (WHISPER_ROUTING_STRATEGY=structure)
            STRUCTURE_PROVIDER=openai
            STRUCTURE_MODEL=gpt-4o-transcribe
            STRUCTURE_DRAFT_THRESHOLD=20
            STRUCTURE_EMOJI_LEVEL=1 #0=none, 1=few, 2=moderate, 3=many

            # LLM Text Refinement
            LLM_REFINEMENT_ENABLED=true #–¥–ª—è mode=structure –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            LLM_PROVIDER=deepseek #deepseek, openai, gigachat
            LLM_MODEL=deepseek-chat #deepseek-chat (8K output) –∏–ª–∏ deepseek-reasoner (64K output)
            LLM_BASE_URL=https://api.deepseek.com
            LLM_MAX_TOKENS=8192 #max 8192 output tokens –¥–ª—è deepseek-chat
            LLM_CHUNKING_THRESHOLD=1300 #–ø—Ä–∏–º–µ—Ä–Ω–æ 5 –º–∏–Ω (–µ—Å–ª–∏ —Å—á–∏—Ç–∞—Ç—å 260 —Ç–æ–∫–µ–Ω–æ–≤ –≤ –º–∏–Ω—É—Ç—É). –ü–æ—Ä–æ–≥ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è chunking (default: LLM_MAX_TOKENS).
            LLM_MAX_TOKENS_REASONER=64000 #max output tokens –¥–ª—è deepseek-reasoner
            LLM_LONG_TEXT_STRATEGY=chunking #reasoner –∏–ª–∏ chunking (–¥–ª—è deepseek-chat)
            LLM_CHUNK_MAX_CHARS=4096 #—Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö –¥–ª—è chunking —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏. Default 4096
            LLM_PARALLEL_CHUNKS=true #–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ LLM —á–∞–Ω–∫–æ–≤
            LLM_MAX_PARALLEL_CHUNKS=8 #–º–∞–∫—Å. –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö LLM –∑–∞–ø—Ä–æ—Å–æ–≤ (1-10). Default: 8
            LLM_TIMEOUT=300
            LLM_DEBUG_MODE=false #true = sends comparison message (draft vs refined)

            # Audio Preprocessing
            AUDIO_CONVERT_TO_MONO=true
            AUDIO_TARGET_SAMPLE_RATE=16000
            AUDIO_SPEED_MULTIPLIER=1.0

            # Database
            DATABASE_URL=sqlite+aiosqlite:////app/data/bot.db

            # Logging
            LOG_LEVEL=INFO
            LOG_DIR=./logs

            # Processing
            MAX_CONCURRENT_WORKERS=5
            MAX_QUEUE_SIZE=10
            MAX_VOICE_DURATION_SECONDS=10800
            TRANSCRIPTION_TIMEOUT=3600
            PROGRESS_RTF=0.05
            PROGRESS_UPDATE_INTERVAL=3

            # Quota
            DEFAULT_DAILY_QUOTA_SECONDS=60 #–µ—â–µ –Ω–µ –≤–Ω–µ–¥—Ä–µ–Ω–æ

            # Buttons
            INTERACTIVE_MODE_ENABLED=true
            ENABLE_STRUCTURED_MODE=true
            ENABLE_MAGIC_MODE=true
            ENABLE_SUMMARY_MODE=true
            ENABLE_LENGTH_VARIATIONS=true
            ENABLE_EMOJI_OPTION=true
            ENABLE_TIMESTAMPS_OPTION=false
            ENABLE_RETRANSCRIBE=false #–ø–æ–≤—Ç–æ—Ä–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≤ –ª—É—á—à–µ–º –∫–∞—á–µ—Å—Ç–≤–µ
            ENABLE_DOWNLOAD_BUTTON=true #—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –≤ MD, TXT, PDF, DOCX

            FILE_THRESHOLD_CHARS=3900 # –°–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞
            
            PERSISTENT_AUDIO_DIR=./data/audio_files
            PERSISTENT_AUDIO_TTL_DAYS=1
            RETRANSCRIBE_FREE_MODEL=medium
            RETRANSCRIBE_FREE_MODEL_RTF=0.6
            RETRANSCRIBE_PAID_PROVIDER=openai
            RETRANSCRIBE_PAID_COST_PER_MINUTE=1.0 # –°—Ç–æ–∏–º–æ—Å—Ç—å 1–π –º–∏–Ω—É—Ç—ã –≤ —Ä—É–±–ª—è—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
            LLM_PROCESSING_DURATION=30  # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ LLM –ø–æ –∫–Ω–æ–ø–∫–µ

            # Document and Video Support
            ENABLE_DOCUMENT_HANDLER=true  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            ENABLE_VIDEO_HANDLER=true     # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏–æ –∏–∑ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤

            # Application Version (for centralized logging)
            APP_VERSION=$VERSION

            # Optional: Remote Syslog Configuration
            # Uncomment and configure if using remote log aggregation
            # SYSLOG_ENABLED=false
            # SYSLOG_HOST=logs.example.com
            # SYSLOG_PORT=514
            EOF

            # Pull Docker image with version tag
            docker pull ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION

            # Tag as latest
            docker tag ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION \
                       ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:latest

            # Update IMAGE_NAME in .env for docker-compose
            echo "IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot:$VERSION" >> .env

            # Create required directories (if not exist)
            mkdir -p data logs

            # Set permissions for appuser inside container (UID 1000)
            chown -R 1000:1000 data logs

            # Rolling update with zero downtime
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps bot

            # Wait for container to be healthy
            echo "‚è≥ Waiting for health check..."
            sleep 15

            # Check if container is healthy
            CONTAINER_STATUS=$(docker inspect --format='{{.State.Health.Status}}' telegram-voice2text-bot 2>/dev/null || echo "unknown")

            if [ "$CONTAINER_STATUS" != "healthy" ] && [ "$CONTAINER_STATUS" != "unknown" ]; then
              echo "‚ùå Health check failed! Container status: $CONTAINER_STATUS"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50 bot
              exit 1
            fi

            # Show status
            echo "‚úÖ Deployment successful! Version $VERSION is now live."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps

            # Cleanup old images (keep last 3 versions)
            echo "üßπ Cleaning up old Docker images..."
            docker images ${{ secrets.DOCKER_USERNAME }}/telegram-voice2text-bot --format "{{.ID}} {{.CreatedAt}}" | \
              tail -n +4 | awk '{print $1}' | xargs -r docker rmi || true

            echo "üéâ Deployment complete!"
