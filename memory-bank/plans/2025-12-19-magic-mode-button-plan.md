# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ" (Magic Mode)

**–î–∞—Ç–∞**: 2025-12-19
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–†–∏—Å–∫–∏**: –ù–∏–∑–∫–∏–µ

---

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ", –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≥–æ–ª–æ—Å–æ–≤—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram —Å –∂–∏–≤—ã–º —Å—Ç–∏–ª–µ–º –∏ —É–º–µ—Ä–µ–Ω–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

- **–†–µ–∂–∏–º**: `magic` (–Ω–æ–≤—ã–π)
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –ü–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏ "üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å", –ø–µ—Ä–µ–¥ "üìå –û —á–µ–º —Ç–µ–∫—Å—Ç?"
- **–í–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª–∏–Ω—ã**: –ù–ï–¢ (–±–µ–∑ –∫–Ω–æ–ø–æ–∫ "–ö–æ—Ä–æ—á–µ"/"–î–ª–∏–Ω–Ω–µ–µ")
- **Emoji level**: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π = 1 (–Ω–µ–º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏)
- **–õ–æ–≥–∏–∫–∞**: –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞ —Ä–µ–∂–∏–º–∞–º "structured" –∏ "summary"

### –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç "Structured"

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Structured | Magic |
|----------|-----------|-------|
| –¶–µ–ª—å | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç | –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ |
| –°—Ç–∏–ª—å | –§–æ—Ä–º–∞–ª—å–Ω—ã–π/–¥–µ–ª–æ–≤–æ–π | –ñ–∏–≤–æ–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, "–≤ –≥–æ–ª–æ—Å–µ –∞–≤—Ç–æ—Ä–∞" |
| –í–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª–∏–Ω—ã | ‚úÖ –ï—Å—Ç—å | ‚ùå –ù–µ—Ç |
| Emoji control | ‚úÖ –£–ø—Ä–∞–≤–ª—è–µ–º—ã–π (0-3) | ‚ö†Ô∏è –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (1) |
| –ü—Ä–æ–º–ø—Ç | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ | –ö–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –ù–æ–≤—ã–π —Ä–µ–∂–∏–º "magic"

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:
- ‚úÖ –°–ª–µ–¥—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ (–∫–∞–∫ structured/summary)
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π UX
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

**TranscriptionState**:
- `active_mode`: –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ `"magic"`
- `emoji_level`: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è = 1 –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ magic mode
- `length_level`: –≤—Å–µ–≥–¥–∞ `"default"` (–≤–∞—Ä–∏–∞—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã)
- `timestamps_enabled`: —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ

**TranscriptionVariant**:
- `mode = "magic"`
- `length_level = "default"` (–≤—Å–µ–≥–¥–∞)
- `emoji_level = 1` (–≤—Å–µ–≥–¥–∞)
- `timestamps_enabled = False/True` (–∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–µ—Ä–µ—Ç)

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç

**–§–∞–π–ª**: `prompts/magic.md`

**–î–µ–π—Å—Ç–≤–∏–µ**: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –ø—Ä–æ–º–ø—Ç–æ–º –¥–ª—è LLM

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ**:

```markdown
**Your role**
–†–µ–¥–∞–∫—Ç–æ—Ä-—Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ç–æ—Ä –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –£–º–µ–µ—à—å –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å—É–º–±—É—Ä–Ω—É—é –¥–∏–∫—Ç–æ—Ñ–æ–Ω–Ω—É—é —Ä–µ—á—å –≤ –∂–∏–≤–æ–π, —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –∞–≤—Ç–æ—Ä–∞.

**Task**
–ü—Ä–µ–æ–±—Ä–∞–∑—É–π –ø–æ—Ç–æ–∫ –º—ã—Å–ª–µ–π –∏–∑ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–∏ (–¥–∏–∫—Ç–æ—Ñ–æ–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è) –≤ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram.

**What to do**
- –°–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª, –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é –∏ –ø–æ—Ç–æ–∫–æ–≤–æ–µ –º—ã—à–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞.
- –°–¥–µ–ª–∞–π —Å–≤—è–∑–Ω—ã–π, —Ç—ë–ø–ª—ã–π, —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç ¬´–≤ –≥–æ–ª–æ—Å–µ¬ª –∞–≤—Ç–æ—Ä–∞.
- –ë–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä—â–∏–Ω—ã –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Ç–æ–Ω–∞.
- –≠–º–æ–¥–∑–∏ ‚Äî –ø–æ —Å–º—ã—Å–ª—É –∏ —É–º–µ—Ä–µ–Ω–Ω–æ.
- –ï—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - `<b>` ‚Äî –∂–∏—Ä–Ω—ã–π
  - `<i>` ‚Äî –∫—É—Ä—Å–∏–≤
  - `<u>` ‚Äî –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ
  - `<code>` ‚Äî –∫–æ–¥ / —Ç–µ—Ä–º–∏–Ω—ã
- –°—Å—ã–ª–∫–∏ –æ—Ñ–æ—Ä–º–ª—è–π —Ç–∞–∫: `<a href="https://example.com">—Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏</a>`

**Output rules (–≤–∞–∂–Ω–æ)**
- –í–µ—Ä–Ω–∏ **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç —Ç–µ–∫—Å—Ç–∞**.
- **–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, —Ä–∞–∑–±–æ—Ä–æ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –≤–µ—Ä—Å–∏–π.**
- –¢–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, –≥–æ—Ç–æ–≤—ã–π –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.

**Goal**
–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Å—ã—Ä–æ–π –ø–æ—Ç–æ–∫ –º—ã—Å–ª–µ–π –∏–∑ –∞—É–¥–∏–æ –≤ –ø—É–±–ª–∏–∫—É–µ–º—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∂–∏–≤–æ—Å—Ç–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏.

**Style guidelines**
- –î–æ–ø—É—Å—Ç–∏–º —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –∂–∏–≤–æ–π, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ç–æ–Ω.
- –û–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω–æ–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.
- –í–æ–∑–º–æ–∂–Ω–∞ –ª—ë–≥–∫–∞—è —Å–∞–º–æ–∏—Ä–æ–Ω–∏—è, —Å–æ–º–Ω–µ–Ω–∏—è, –∂–∏–≤—ã–µ –æ–≥–æ–≤–æ—Ä–∫–∏.
- –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ —á–∏—Ç–∞—Ç–µ–ª—é –∫–∞–∫ –∫ –∑–Ω–∞–∫–æ–º–æ–º—É ‚Äî –µ—Å–ª–∏ —ç—Ç–æ –æ—Ä–≥–∞–Ω–∏—á–Ω–æ.
- –ò—Å–ø–æ–ª—å–∑—É–π –≤—ã–¥–µ–ª–µ–Ω–∏—è, —Ç–∏—Ä–µ –∏ —Å–ø–∏—Å–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ —É–ª—É—á—à–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ "‚Äî", –∞ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–æ–µ "-"

**HTML Formatting Constraints (–í–ê–ñ–ù–û!)**

‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ —Ç–µ–≥–∏ (–æ–Ω–∏ –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è Telegram):
- `<p>`, `<div>`, `<span>`
- `<ul>`, `<ol>`, `<li>`
- `<h1>`, `<h2>`, `<h3>`
- `<br>` (–∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏)

‚úÖ –ï—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ HTML-—Ç–µ–≥–∏:
- `<b>` –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- `<i>` –¥–ª—è –∫—É—Ä—Å–∏–≤–∞
- `<u>` –¥–ª—è –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
- `<code>` –¥–ª—è –∫–æ–¥–∞/—Ç–µ—Ä–º–∏–Ω–æ–≤
- `<pre>` –¥–ª—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
- `<a href="URL">` –¥–ª—è —Å—Å—ã–ª–æ–∫

–î–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç:
‚Ä¢ –ü—É–Ω–∫—Ç 1
‚Ä¢ –ü—É–Ω–∫—Ç 2

–∏–ª–∏

1. –ü—É–Ω–∫—Ç 1
2. –ü—É–Ω–∫—Ç 2

**Input text (transcription)**:
{text}

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è**:
- –ü—Ä–æ–º–ø—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Å–∏—Å—Ç–µ–º—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Telegram
- –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ HTML-—Ç–µ–≥–∏ (—Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ)
- –®–∞–±–ª–æ–Ω–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `{text}` –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

---

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ TextProcessor

**–§–∞–π–ª**: `src/services/text_processor.py`

**–î–µ–π—Å—Ç–≤–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `create_magic()` –ø–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ `summarize_text()` (–ø—Ä–∏–º–µ—Ä–Ω–æ —Å—Ç—Ä–æ–∫–∞ 341)

**–ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è**:

```python
async def create_magic(self, original_text: str) -> str:
    """
    Create publication-ready text from transcription (Magic mode).

    Transforms raw transcription into warm, readable post for Telegram
    while preserving author's voice, tone, and authenticity.

    Args:
        original_text: Raw transcription text

    Returns:
        Publication-ready text with formatting and emojis

    Raises:
        LLMError: If processing fails
    """
    # Load prompt from file
    try:
        prompt_template = load_prompt("magic")
    except (FileNotFoundError, IOError) as e:
        logger.error(f"Failed to load magic prompt: {e}")
        # Fallback to inline prompt (shortened version)
        prompt_template = """–ü—Ä–µ–æ–±—Ä–∞–∑—É–π –¥–∏–∫—Ç–æ—Ñ–æ–Ω–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram.

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:
{text}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –°–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª, –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é –∏ —Å—Ç–∏–ª—å –∞–≤—Ç–æ—Ä–∞
2. –°–¥–µ–ª–∞–π —Å–≤—è–∑–Ω—ã–π, —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
3. –î–æ–±–∞–≤—å —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ (–ø–æ —Å–º—ã—Å–ª—É)
4. –ò—Å–ø–æ–ª—å–∑—É–π HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ: <b>, <i>, <code>
5. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ–≥–∏: <p>, <ul>, <li>, <h1>, <br>
6. –î–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—Å—Ç: ‚Ä¢ –∏–ª–∏ 1.
7. –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π, –∂–∏–≤–æ–π —Ç–æ–Ω (–±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä—â–∏–Ω—ã)

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π."""

    prompt = prompt_template.format(text=original_text)
    logger.info(f"Creating magic text ({len(original_text)} chars)...")

    try:
        # Use custom prompt for magic transformation
        magic_text = await self._refine_with_custom_prompt(original_text, prompt)

        # Sanitize HTML to remove unsupported tags
        magic_text = sanitize_html(magic_text)

        logger.info(f"Magic text created: {len(original_text)} ‚Üí {len(magic_text)} chars")
        return magic_text

    except LLMError as e:
        logger.error(f"Failed to create magic text: {e}")
        # Fallback: return original text
        logger.warning("Falling back to original text")
        return original_text
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è**:
- –ú–µ—Ç–æ–¥ —Å–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É `create_structured()` –∏ `summarize_text()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `load_prompt("magic")` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–∞
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç `sanitize_html()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- Fallback –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ

---

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–§–∞–π–ª**: `src/config.py`

**–î–µ–π—Å—Ç–≤–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É `ENABLE_MAGIC_MODE` –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `ENABLE_SUMMARY_MODE`

**–ù–∞–π—Ç–∏ –±–ª–æ–∫** (–ø—Ä–∏–º–µ—Ä–Ω–æ —Å—Ç—Ä–æ–∫–∞ 147):

```python
ENABLE_SUMMARY_MODE: bool = Field(
    default=True,
    description="Enable summary mode ('What's the text about?')",
)
```

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –Ω–µ–≥–æ**:

```python
ENABLE_MAGIC_MODE: bool = Field(
    default=True,
    description="Enable magic mode ('Make it beautiful') - publication-ready text",
)
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è**:
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω (`default=True`)
- –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –°–ª–µ–¥—É–µ—Ç —Å—Ç–∏–ª—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

### –®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É

**–§–∞–π–ª**: `src/bot/keyboards.py`

**–î–µ–π—Å—Ç–≤–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ" –ø–æ—Å–ª–µ –±–ª–æ–∫–∞ "Structured mode"

**–ù–∞–π—Ç–∏ –±–ª–æ–∫ "Row 2: Structured mode"** (—Å—Ç—Ä–æ–∫–∏ 91-147):

```python
# Row 2: Structured mode (Phase 2 + Phase 3 length variations)
if settings.enable_structured_mode:
    if state.active_mode == "structured" and settings.enable_length_variations:
        # ... –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ ...
    else:
        # ... –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ ...
```

**–î–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï –±–ª–æ–∫–∞ structured (–ø–µ—Ä–µ–¥ "Row 3: Summary mode", —Å—Ç—Ä–æ–∫–∞ 149)**:

```python
# Row 3: Magic mode (Phase 9) - publication-ready text
if settings.enable_magic_mode:
    label = (
        "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ (–≤—ã –∑–¥–µ—Å—å)"
        if state.active_mode == "magic"
        else "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ"
    )
    keyboard.append(
        [
            InlineKeyboardButton(
                label,
                callback_data=encode_callback_data("mode", state.usage_id, mode="magic"),
            )
        ]
    )
```

**–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**:
- –°—Ç–∞—Ä—ã–π "Row 3: Summary mode" ‚Üí **"Row 4: Summary mode"**
- –°—Ç–∞—Ä—ã–π "Row 4: Emoji option" ‚Üí **"Row 5: Emoji option"**
- –°—Ç–∞—Ä—ã–π "Row 5: Timestamps option" ‚Üí **"Row 6: Timestamps option"**
- –°—Ç–∞—Ä—ã–π "Row 6: Retranscribe" ‚Üí **"Row 7: Retranscribe"**

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è**:
- –ö–Ω–æ–ø–∫–∞ –ë–ï–ó –≤–∞—Ä–∏–∞—Ü–∏–π –¥–ª–∏–Ω—ã (–Ω–µ –Ω—É–∂–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞)
- –ü—Ä–æ—Å—Ç–∞—è –æ–¥–Ω–æ–∫–Ω–æ–ø–æ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "(–≤—ã –∑–¥–µ—Å—å)" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ active mode

---

### –®–∞–≥ 5: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ callbacks

**–§–∞–π–ª**: `src/bot/callbacks.py`

#### 5.1. –û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä–µ–∂–∏–º–æ–≤

**–ù–∞–π—Ç–∏** —Ñ—É–Ω–∫—Ü–∏—é `handle_mode_change()`, —Å—Ç—Ä–æ–∫—É 316:

```python
if new_mode not in ["original", "structured", "summary"]:
    await query.answer("–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö", show_alert=True)
    return
```

**–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞**:

```python
if new_mode not in ["original", "structured", "summary", "magic"]:
    await query.answer("–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö", show_alert=True)
    return
```

#### 5.2. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–ù–∞–π—Ç–∏** –±–ª–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ `enable_summary_mode` (—Å—Ç—Ä–æ–∫–∞ 312):

```python
if new_mode == "summary" and not settings.enable_summary_mode:
    await query.answer("–†–µ–∂–∏–º —Ä–µ–∑—é–º–µ –æ—Ç–∫–ª—é—á–µ–Ω", show_alert=True)
    return
```

**–î–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï**:

```python
if new_mode == "magic" and not settings.enable_magic_mode:
    await query.answer("Magic —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω", show_alert=True)
    return
```

#### 5.3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è magic mode

**–ù–∞–π—Ç–∏** –±–ª–æ–∫ "Reset formatting parameters" (—Å—Ç—Ä–æ–∫–∞ 320-325):

```python
# Reset formatting parameters when switching modes
# This ensures consistency: when switching modes, we start with default formatting
# Users can then adjust emoji/length/timestamps for the new mode
target_emoji_level = 1 if new_mode == "structured" else 0
target_length_level = "default"
target_timestamps_enabled = False
```

**–ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å `target_emoji_level`**:

```python
target_emoji_level = 1 if new_mode in ["structured", "magic"] else 0
```

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ**:
- –î–ª—è "structured" –∏ "magic" —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è emoji_level = 1
- –î–ª—è "original" –∏ "summary" - 0

#### 5.4. –î–æ–±–∞–≤–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é magic –≤–∞—Ä–∏–∞–Ω—Ç–∞

**–ù–∞–π—Ç–∏** –±–ª–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ "summary" (–ø—Ä–∏–º–µ—Ä–Ω–æ —Å—Ç—Ä–æ–∫–∞ 535-600)

**–î–æ–±–∞–≤–∏—Ç—å –ü–û–°–õ–ï –±–ª–æ–∫–∞ summary (–ø–µ—Ä–µ–¥ `else: # original mode`)**:

```python
elif new_mode == "magic":
    # Generate magic (publication-ready) text
    if not self.text_processor:
        await query.answer(
            "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (LLM –æ—Ç–∫–ª—é—á–µ–Ω)", show_alert=True
        )
        return

    # Get original text
    original_variant = await self.variant_repo.get_variant(
        usage_id=usage_id, mode="original"
    )
    if not original_variant:
        await query.answer("–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    # Acknowledge callback immediately
    await query.answer("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...")

    # Edit message to show processing started
    processing_message = "ü™Ñ –î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."
    try:
        await query.edit_message_text(processing_message)
    except Exception as e:
        logger.warning(f"Failed to update message to processing state: {e}")

    # Start progress tracker
    progress = ProgressTracker(
        message=cast(Message, query.message),
        duration_seconds=settings.llm_processing_duration,
        rtf=1.0,
        update_interval=settings.progress_update_interval,
    )
    await progress.start()

    # Generate magic text
    try:
        start_time = time.time()

        magic_text = await self.text_processor.create_magic(
            original_variant.text_content
        )

        processing_time = time.time() - start_time

        # Stop progress tracker
        await progress.stop()

        # Check if variant already exists
        existing_variant = await self.variant_repo.get_variant(
            usage_id=usage_id,
            mode="magic",
            length_level=target_length_level,
            emoji_level=target_emoji_level,
            timestamps_enabled=target_timestamps_enabled,
        )

        if existing_variant:
            # Update existing variant
            existing_variant.text_content = magic_text
            existing_variant.processing_time_seconds = processing_time
            await self.variant_repo.update(existing_variant)
            variant = existing_variant
            logger.info(f"Updated existing magic variant: id={variant.id}")
        else:
            # Create new variant
            variant = await self.variant_repo.create(
                usage_id=usage_id,
                mode="magic",
                text_content=magic_text,
                length_level=target_length_level,
                emoji_level=target_emoji_level,
                timestamps_enabled=target_timestamps_enabled,
                generated_by="llm",
                llm_model=settings.llm_model,
                processing_time_seconds=processing_time,
            )
            logger.info(f"Created magic variant: id={variant.id}")

    except Exception as e:
        logger.error(f"Failed to generate magic text: {e}", exc_info=True)
        await progress.stop()
        await query.answer("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç", show_alert=True)
        return
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è**:
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ "summary" –∏ "structured"
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `text_processor.create_magic()`
- Progress tracker —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "ü™Ñ –î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ..."
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å `mode="magic"`, `emoji_level=1`

---

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫–∏ —Ä–µ–∂–∏–º–æ–≤

**–§–∞–π–ª**: `src/bot/callbacks.py`

**–î–µ–π—Å—Ç–≤–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –¥–ª—è magic mode –≤ —Å–ª–æ–≤–∞—Ä–∏ `mode_labels`

**–ù–∞–π—Ç–∏** (—Å—Ç—Ä–æ–∫–∏ 97-102):

```python
# Get mode label
mode_labels = {
    "original": "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç",
    "structured": "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
    "summary": "–†–µ–∑—é–º–µ",
}
mode_label = mode_labels.get(state.active_mode, state.active_mode)
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ª–æ–≤–∞—Ä—å**:

```python
mode_labels = {
    "original": "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç",
    "structured": "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
    "summary": "–†–µ–∑—é–º–µ",
    "magic": "–ö—Ä–∞—Å–∏–≤–æ",
}
```

**–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö –≤—Ö–æ–∂–¥–µ–Ω–∏–π** (–µ—Å—Ç—å –µ—â–µ –≤ —Å—Ç—Ä–æ–∫–∞—Ö 154-159):

```python
mode_labels = {
    "original": "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç",
    "structured": "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
    "summary": "–†–µ–∑—é–º–µ",
    "magic": "–ö—Ä–∞—Å–∏–≤–æ",
}
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ magic –≤–∞—Ä–∏–∞–Ω—Ç–∞

**–®–∞–≥–∏**:
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
2. –î–æ–∂–¥–∞—Ç—å—Å—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
3. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –ü–æ—è–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "ü™Ñ –î–µ–ª–∞—é –∫—Ä–∞—Å–∏–≤–æ..."
   - –¢–µ–∫—Å—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ LLM
   - –†–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
   - –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "(–≤—ã –∑–¥–µ—Å—å)"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –¢–µ–∫—Å—Ç –∂–∏–≤–æ–π, —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π, —Å —ç–º–æ–¥–∑–∏
- HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
- –†–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è –Ω–∞ "magic"

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏

**–®–∞–≥–∏**:
1. –ò–∑ magic —Ä–µ–∂–∏–º–∞ –Ω–∞–∂–∞—Ç—å "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç"
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ original
3. –ù–∞–∂–∞—Ç—å "üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
4. –ù–∞–∂–∞—Ç—å "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ"
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤–∞—Ä–∏–∞–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –∫—ç—à–∞ (–±—ã—Å—Ç—Ä–æ)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–∞–≤–Ω–æ
- –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ –ë–î –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã "(–≤—ã –∑–¥–µ—Å—å)" –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Emoji level

**–®–∞–≥–∏**:
1. –°–æ–∑–¥–∞—Ç—å magic –≤–∞—Ä–∏–∞–Ω—Ç
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î: `emoji_level = 1`
3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ emoji_level —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ 0

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- Magic –≤—Å–µ–≥–¥–∞ —Å emoji_level = 1
- Original —Å emoji_level = 0

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–®–∞–≥–∏**:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `ENABLE_MAGIC_MODE=false` –≤ .env
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä—ã—Ç–∞
- –†–µ–∂–∏–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (—Ñ–∞–π–ª–æ–≤—ã–π —Ä–µ–∂–∏–º)

**–®–∞–≥–∏**:
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–ª–∏–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ (>4000 —Å–∏–º–≤–æ–ª–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏)
2. –ù–∞–∂–∞—Ç—å "ü™Ñ –°–¥–µ–ª–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –§–∞–π–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - PDF –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –§–∞–π–ª–æ–≤—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–µ–∫—Å—Ç–æ–º –∏ —Ñ–∞–π–ª–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ö–æ–¥-—Ä–µ–≤—å—é —á–µ–∫–ª–∏—Å—Ç

- [ ] –ü—Ä–æ–º–ø—Ç —Å–æ–∑–¥–∞–Ω –≤ `prompts/magic.md`
- [ ] –ú–µ—Ç–æ–¥ `create_magic()` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `TextProcessor`
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `ENABLE_MAGIC_MODE` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `config.py`
- [ ] –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ `keyboards.py` –ø–æ—Å–ª–µ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ `callbacks.py`
- [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `callbacks.py`
- [ ] –ú–µ—Ç–∫–∏ —Ä–µ–∂–∏–º–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (–≤—Å–µ —Å–ª–æ–≤–∞—Ä–∏ `mode_labels`)
- [ ] `emoji_level = 1` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –¥–ª—è magic mode
- [ ] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ "Row X" –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ magic –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°—Ü–µ–Ω–∞—Ä–∏–π 3: Emoji level –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- [ ] –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°—Ü–µ–Ω–∞—Ä–∏–π 5: –§–∞–π–ª–æ–≤—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û—à–∏–±–∫–∏ LLM –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (fallback)
- [ ] –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [ ] HTML-—Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ—Ç –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–µ–≥–æ–≤)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- [ ] `TranscriptionVariant` —Å `mode="magic"` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] `emoji_level=1` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] `length_level="default"` –≤—Å–µ–≥–¥–∞
- [ ] –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π variant)

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|---------|-----------|
| LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ HTML-—Ç–µ–≥–∏ | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω–µ–µ | `sanitize_html()` —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| –ü—Ä–æ–º–ø—Ç –¥–∞–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω–µ–µ | Fallback –Ω–∞ original text |
| Emoji level –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è | –ù–∏–∑–∫–∞—è | –ù–∏–∑–∫–æ–µ | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —è–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ |
| –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –¥—Ä—É–≥–∏–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ | –ù–∏–∑–∫–∞—è | –ù–∏–∑–∫–æ–µ | –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ |
| –î–ª–∏–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–æ–µ | Progress tracker + timeout |

---

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π

1. `prompts/magic.md` - –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM

### –ò–∑–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

2. `src/services/text_processor.py` - –ú–µ—Ç–æ–¥ `create_magic()`
3. `src/config.py` - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `ENABLE_MAGIC_MODE`
4. `src/bot/keyboards.py` - –ö–Ω–æ–ø–∫–∞ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
5. `src/bot/callbacks.py` - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤**: 5 (1 –Ω–æ–≤—ã–π + 4 –∏–∑–º–µ–Ω–µ–Ω–∏—è)

---

## –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

- **–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 1-2 —á–∞—Å–∞
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~150 –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è (—Å–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É)
- **–†–∏—Å–∫–∏**: –ù–∏–∑–∫–∏–µ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

---

## –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

- [ ] –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É: `git checkout -b feature/magic-mode-button`
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ LLM –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

- [ ] ‚úÖ –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å `prompts/magic.md`
- [ ] ‚úÖ –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å `create_magic()` –≤ `text_processor.py`
- [ ] ‚úÖ –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å `ENABLE_MAGIC_MODE` –≤ `config.py`
- [ ] ‚úÖ –®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ `keyboards.py`
- [ ] ‚úÖ –®–∞–≥ 5: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ `callbacks.py`
- [ ] ‚úÖ –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫–∏ —Ä–µ–∂–∏–º–æ–≤

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π 1 (—Å–æ–∑–¥–∞–Ω–∏–µ magic)
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π 2 (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤)
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π 3 (emoji level)
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π 5 (–¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

### –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è

- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `black src/` –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥-—Ä–µ–≤—å—é —á–µ–∫–ª–∏—Å—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç: `git commit -m "feat: add magic mode button for publication-ready text"`
- [ ] –°–æ–∑–¥–∞—Ç—å PR: `gh pr create --title "feat: magic mode button" --body "..."`

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –í–∞–∂–Ω–æ

1. **Emoji level**: –í—Å–µ–≥–¥–∞ = 1 –¥–ª—è magic mode (–ø—Ä–æ–º–ø—Ç —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º)
2. **Length variations**: –ù–ï–¢ –¥–ª—è magic mode (—Ç–æ–ª—å–∫–æ default)
3. **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –ü–æ—Å–ª–µ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å", –ø–µ—Ä–µ–¥ "–û —á–µ–º —Ç–µ–∫—Å—Ç?"

### –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–≤–Ω–µ —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞)

- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
- –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ—Ü–µ–Ω–∫–∏)
- –í–∞—Ä–∏–∞—Ü–∏–∏ —Ç–æ–Ω–∞ (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π)

---

**–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: ‚úÖ
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –ù–∞—á–∞—Ç—å —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ (`prompts/magic.md`)
