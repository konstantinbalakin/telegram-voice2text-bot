# Plan: Queue Notifications Improvement

**Date**: 2025-01-19
**Status**: Approved

## Summary

–£–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—á–µ—Ä–µ–¥–∏: —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è, –ø–æ–Ω—è—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏.

## Selected Option

**Option 2: Full Implementation** - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

## Technical Approach

### 1. QueueManager Changes (`src/services/queue_manager.py`)

- –î–æ–±–∞–≤–∏—Ç—å `_pending_requests: list[TranscriptionRequest]` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –æ—á–µ—Ä–µ–¥–∏
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `get_estimated_wait_time(position: int) -> tuple[float, float]`:
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–≤—Ä–µ–º—è_–æ–∂–∏–¥–∞–Ω–∏—è, –≤—Ä–µ–º—è_–æ–±—Ä–∞–±–æ—Ç–∫–∏)
  - –£—á–∏—Ç—ã–≤–∞–µ—Ç `_max_concurrent` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
  - –°—É–º–º–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–ø–µ—Ä–µ–¥–∏
- –î–æ–±–∞–≤–∏—Ç—å callback `on_queue_changed` –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è handlers
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å `_pending_requests` —Å `_queue` –ø—Ä–∏ enqueue/dequeue

### 2. Handlers Changes (`src/bot/handlers.py`)

- –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_update_queue_messages()`:
  - –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –æ–∂–∏–¥–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
  - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
- –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
  ```
  üìã –í –æ—á–µ—Ä–µ–¥–∏: –ø–æ–∑–∏—Ü–∏—è X
  ‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏: ~Y—Å
  üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ~Z—Å
  ```
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è callback –≤ QueueManager

### 3. Wait Time Calculation Formula

```python
def calculate_wait_time(position, pending_requests, max_concurrent, rtf):
    # –°–æ–æ–±—â–µ–Ω–∏—è –≤–ø–µ—Ä–µ–¥–∏ (–Ω–µ –≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–µ–µ)
    items_ahead = pending_requests[:position - 1]

    # –û–±—â–µ–µ –≤—Ä–µ–º—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–ø–µ—Ä–µ–¥–∏
    total_duration = sum(r.duration_seconds for r in items_ahead)

    # –í—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç–∏
    wait_time = (total_duration * rtf) / max_concurrent

    # –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    current_duration = pending_requests[position - 1].duration_seconds
    processing_time = current_duration * rtf

    return wait_time, processing_time
```

## Implementation Steps

1. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `QueueManager`:
   - –î–æ–±–∞–≤–∏—Ç—å `_pending_requests` —Å–ø–∏—Å–æ–∫
   - –û–±–Ω–æ–≤–∏—Ç—å `enqueue()` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫
   - –û–±–Ω–æ–≤–∏—Ç—å `_process_request()` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –≤—ã–∑–æ–≤–∞ callback
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏

2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `BotHandlers`:
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å callback –≤ QueueManager
   - –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –≤ voice_message_handler –∏ audio_message_handler

3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏ max_concurrent > 1

## Risk Mitigation

- **Rate limits**: –î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
- **Error handling**: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **Concurrency**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å asyncio.Lock –¥–ª—è –∑–∞—â–∏—Ç—ã _pending_requests

## Success Criteria

- [ ] –ü–æ–∑–∏—Ü–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- [ ] –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
- [ ] –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- [ ] –°–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏
- [ ] –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö
