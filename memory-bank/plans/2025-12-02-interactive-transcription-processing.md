# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-02
**–°—Ç–∞—Ç—É—Å:** –£—Ç–≤–µ—Ä–∂–¥—ë–Ω
**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** –§–∞–∑–æ–≤—ã–π MVP –ø–æ–¥—Ö–æ–¥ (–í–∞—Ä–∏–∞–Ω—Ç 1)
**–¶–µ–ª–µ–≤–æ–π —Å—Ä–æ–∫:** 13-18 –¥–Ω–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è)
3. [–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#—Å—Ö–µ–º–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
4. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–º–æ–¥—É–ª–µ–π)
5. [–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–æ —Ñ–∞–∑–∞–º](#–¥–µ—Ç–∞–ª—å–Ω—ã–π-–ø–ª–∞–Ω-–ø–æ-—Ñ–∞–∑–∞–º)
6. [–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞](#–∫—Ä–∏—Ç–µ—Ä–∏–∏-—É—Å–ø–µ—Ö–∞)
7. [–†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏–∏](#—Ä–∏—Å–∫–∏-–∏-–º–∏—Ç–∏–≥–∞—Ü–∏–∏)

---

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

### –¶–µ–ª—å
–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏ –≤ Telegram, –ø–æ–∑–≤–æ–ª—è—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–∏—Å—Ö–æ–¥–Ω—ã–π/—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π/—Ä–µ–∑—é–º–µ)
- –ò–∑–º–µ–Ω—è—Ç—å –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ (–∫–æ—Ä–æ—á–µ/–¥–ª–∏–Ω–Ω–µ–µ)
- –î–æ–±–∞–≤–ª—è—Ç—å —ç–º–æ–¥–∑–∏
- –í–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å —Ç–∞–π–º–∫–æ–¥—ã
- –ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —Å –ª—É—á—à–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º

### –ü—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ UI

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìù –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –≥–æ—Ç–æ–≤–∞!              ‚îÇ
‚îÇ [–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç]                    ‚îÇ  ‚Üê –†—è–¥ 1: –ë–∞–∑–æ–≤—ã–µ —Ä–µ–∂–∏–º—ã
‚îÇ [–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å]                   ‚îÇ  ‚Üê –†—è–¥ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ [–û —á–µ–º —Ç–µ–∫—Å—Ç?]                      ‚îÇ  ‚Üê –†—è–¥ 3: –†–µ–∑—é–º–µ
‚îÇ [üòä –°–º–∞–π–ª—ã]                         ‚îÇ  ‚Üê –†—è–¥ 4: –û–ø—Ü–∏—è —Å–º–∞–π–ª–æ–≤
‚îÇ [‚è± –¢–∞–π–º–∫–æ–¥—ã]                        ‚îÇ  ‚Üê –†—è–¥ 5: –û–ø—Ü–∏—è —Ç–∞–π–º–∫–æ–¥–æ–≤
‚îÇ [‚ö° –ú–æ–≥—É –ª—É—á—à–µ]                      ‚îÇ  ‚Üê –†—è–¥ 6: –ü–æ–≤—Ç–æ—Ä —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫:**
```
–†–µ–∂–∏–º "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å" –∞–∫—Ç–∏–≤–µ–Ω:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç]                    ‚îÇ
‚îÇ [–ö–æ—Ä–æ—á–µ] [üìù] [–î–ª–∏–Ω–Ω–µ–µ]             ‚îÇ  ‚Üê 3 –∫–Ω–æ–ø–∫–∏ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π
‚îÇ [–û —á–µ–º —Ç–µ–∫—Å—Ç?]                      ‚îÇ
‚îÇ [–ú–µ–Ω—å—à–µ] [üòä] [–ë–æ–ª—å—à–µ]              ‚îÇ  ‚Üê –ï—Å–ª–∏ —Å–º–∞–π–ª—ã –∞–∫—Ç–∏–≤–Ω—ã
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è

| –ê—Å–ø–µ–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|--------|---------|-------------|
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** | SQLite (—Ç–µ–∫—É—â–∞—è) | –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –Ω–∞–≥—Ä—É–∑–∫–∏, –ø—Ä–æ—â–µ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ |
| **–•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** | PostgreSQL/SQLite —Ç–∞–±–ª–∏—Ü–∞ + in-memory –∫—ç—à | –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ Redis –¥–ª—è MVP |
| **LLM –ø—Ä–æ–º–ø—Ç—ã** | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ LLMService | –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| **–§–∞–π–ª—ã (>4096 —Å–∏–º–≤–æ–ª–æ–≤)** | –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Ç–µ–∫—Å—Ç + –¥–æ–∫—É–º–µ–Ω—Ç | –û–±—Ö–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram API |
| **–°–µ–≥–º–µ–Ω—Ç—ã faster-whisper** | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ | –î–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º |
| **Feature flags** | Environment variables —á–µ—Ä–µ–∑ Settings | –ì–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é |
| **Callback data** | –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (JSON, base64) | –õ–∏–º–∏—Ç 64 –±–∞–π—Ç–∞ Telegram |

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

**–ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–Ω—Ü–∏–ø:** –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è

```
–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
    ‚Üì
    ‚îú‚îÄ‚Üí –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (default)
    ‚îÇ   ‚îú‚îÄ‚Üí short (–ø—Ä–æ–º–ø—Ç: —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—á–µ –Ω–∞ 20%)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚Üí shorter (–æ—Ç short, –µ—â—ë -20%)
    ‚îÇ   ‚îú‚îÄ‚Üí long (–ø—Ä–æ–º–ø—Ç: —Å–¥–µ–ª–∞—Ç—å –¥–ª–∏–Ω–Ω–µ–µ –Ω–∞ 20%)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚Üí longer (–æ—Ç long, –µ—â—ë +20%)
    ‚îÇ
    ‚îî‚îÄ‚Üí –†–µ–∑—é–º–µ (default)
        ‚îú‚îÄ‚Üí short
        ‚îÇ   ‚îî‚îÄ‚Üí shorter
        ‚îú‚îÄ‚Üí long
        ‚îÇ   ‚îî‚îÄ‚Üí longer
```

**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–ø—Ä–∏–º–µ–Ω–∏–º—ã –∫ –ª—é–±–æ–º—É —É—Ä–æ–≤–Ω—é):**
- –°–º–∞–π–ª—ã: 0 ‚Üí 1-2 emoji ‚Üí 3-5 emoji
- –¢–∞–π–º–∫–æ–¥—ã: off ‚Üí on (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö)

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é:** –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ 90 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å—Ä–∞–∑—É
2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:** –ö–∞–∂–¥—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
3. **TTL:** –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ `VARIANT_CACHE_TTL_DAYS` (default: 7 –¥–Ω–µ–π)
4. **–õ–∏–º–∏—Ç:** –ú–∞–∫—Å–∏–º—É–º `MAX_CACHED_VARIANTS_PER_TRANSCRIPTION` (default: 10)

---

## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### 1. `transcription_states`
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–µ–π.

```sql
CREATE TABLE transcription_states (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- –°–≤—è–∑–∏
    usage_id INTEGER NOT NULL,  -- FK to usage.id
    message_id INTEGER NOT NULL,  -- Telegram message ID with transcription
    chat_id INTEGER NOT NULL,  -- Telegram chat ID

    -- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI
    active_mode VARCHAR(20) NOT NULL DEFAULT 'original',  -- original/structured/summary
    length_level VARCHAR(10) NOT NULL DEFAULT 'default',  -- default/short/shorter/long/longer
    emoji_level INTEGER NOT NULL DEFAULT 0,  -- 0/1/2
    timestamps_enabled BOOLEAN NOT NULL DEFAULT FALSE,

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    is_file_message BOOLEAN NOT NULL DEFAULT FALSE,  -- –¢–µ–∫—Å—Ç –≤ —Ñ–∞–π–ª–µ –∏–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
    file_message_id INTEGER NULL,  -- ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–∞–π–ª–æ–º (–µ—Å–ª–∏ is_file_message=true)

    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- –ò–Ω–¥–µ–∫—Å—ã
    FOREIGN KEY (usage_id) REFERENCES usage(id) ON DELETE CASCADE,
    UNIQUE(message_id, chat_id)  -- –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ = –æ–¥–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
);

CREATE INDEX idx_transcription_states_usage_id ON transcription_states(usage_id);
CREATE INDEX idx_transcription_states_message_chat ON transcription_states(message_id, chat_id);
```

#### 2. `transcription_variants`
–ö—ç—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ç–µ–∫—Å—Ç–∞.

```sql
CREATE TABLE transcription_variants (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- –°–≤—è–∑–∏
    usage_id INTEGER NOT NULL,  -- FK to usage.id

    -- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—Ä–∏–∞–Ω—Ç–∞ (—Å–æ—Å—Ç–∞–≤–Ω–æ–π –∫–ª—é—á)
    mode VARCHAR(20) NOT NULL,  -- original/structured/summary
    length_level VARCHAR(10) NOT NULL,  -- default/short/shorter/long/longer
    emoji_level INTEGER NOT NULL,  -- 0/1/2
    timestamps_enabled BOOLEAN NOT NULL,

    -- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ
    text_content TEXT NOT NULL,  -- –¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞

    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    generated_by VARCHAR(50),  -- llm/formatting (original –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è)
    llm_model VARCHAR(100) NULL,  -- –ú–æ–¥–µ–ª—å LLM –µ—Å–ª–∏ generated_by=llm
    processing_time_seconds FLOAT NULL,

    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_accessed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- –ò–Ω–¥–µ–∫—Å—ã
    FOREIGN KEY (usage_id) REFERENCES usage(id) ON DELETE CASCADE,
    UNIQUE(usage_id, mode, length_level, emoji_level, timestamps_enabled)
);

CREATE INDEX idx_transcription_variants_usage_id ON transcription_variants(usage_id);
CREATE INDEX idx_transcription_variants_last_accessed ON transcription_variants(last_accessed_at);
```

#### 3. `transcription_segments`
–°–µ–≥–º–µ–Ω—Ç—ã —Å —Ç–∞–π–º–∫–æ–¥–∞–º–∏ –∏–∑ faster-whisper (–¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∞—É–¥–∏–æ).

```sql
CREATE TABLE transcription_segments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- –°–≤—è–∑–∏
    usage_id INTEGER NOT NULL,  -- FK to usage.id

    -- –°–µ–≥–º–µ–Ω—Ç –¥–∞–Ω–Ω—ã–µ
    segment_index INTEGER NOT NULL,  -- –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä (0, 1, 2, ...)
    start_time FLOAT NOT NULL,  -- –°–µ–∫—É–Ω–¥—ã
    end_time FLOAT NOT NULL,  -- –°–µ–∫—É–Ω–¥—ã
    text TEXT NOT NULL,  -- –¢–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞

    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- –ò–Ω–¥–µ–∫—Å—ã
    FOREIGN KEY (usage_id) REFERENCES usage(id) ON DELETE CASCADE,
    UNIQUE(usage_id, segment_index)
);

CREATE INDEX idx_transcription_segments_usage_id ON transcription_segments(usage_id);
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic

**–§–∞–π–ª:** `alembic/versions/YYYYMMDD_add_interactive_transcription_tables.py`

–ü–æ—Ä—è–¥–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è:
1. Phase 1: –°–æ–∑–¥–∞—Ç—å `transcription_states` –∏ `transcription_segments`
2. Phase 2: –°–æ–∑–¥–∞—Ç—å `transcription_variants`
3. Rollback –ø–æ–¥–¥–µ—Ä–∂–∫–∞: DROP TABLE –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

```
src/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ callbacks.py          # NEW: –û–±—Ä–∞–±–æ—Ç–∫–∞ callback queries
‚îÇ   ‚îú‚îÄ‚îÄ keyboards.py           # NEW: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä
‚îÇ   ‚îî‚îÄ‚îÄ handlers.py            # MODIFIED: –î–æ–±–∞–≤–∏—Ç—å inline –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ text_processor.py      # NEW: LLM –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ —Ç–µ–∫—Å—Ç–æ–º
‚îÇ   ‚îî‚îÄ‚îÄ llm_service.py         # MODIFIED: –†–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îú‚îÄ‚îÄ models.py              # MODIFIED: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ repositories.py        # MODIFIED: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
‚îÇ
‚îú‚îÄ‚îÄ transcription/
‚îÇ   ‚îî‚îÄ‚îÄ providers/
‚îÇ       ‚îî‚îÄ‚îÄ faster_whisper_provider.py  # MODIFIED: –°–æ—Ö—Ä–∞–Ω—è—Ç—å segments
‚îÇ
‚îú‚îÄ‚îÄ config.py                  # MODIFIED: Feature flags
‚îî‚îÄ‚îÄ main.py                    # MODIFIED: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å callback handler
```

### –ü—Ä–∏–º–µ—Ä—ã —Å–∏–≥–Ω–∞—Ç—É—Ä

#### `src/bot/callbacks.py`
```python
from telegram import Update, InlineKeyboardMarkup
from telegram.ext import ContextTypes

class CallbackHandlers:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback queries –æ—Ç inline –∫–Ω–æ–ø–æ–∫."""

    async def handle_mode_change(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ (original/structured/summary)."""
        pass

    async def handle_length_change(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª–∏–Ω—ã (shorter/longer)."""
        pass

    async def handle_emoji_toggle(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å–º–∞–π–ª–æ–≤."""
        pass

    async def handle_timestamps_toggle(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """–í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–π–º–∫–æ–¥–æ–≤."""
        pass
```

#### `src/bot/keyboards.py`
```python
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from src.storage.models import TranscriptionState
from src.config import Settings

def create_transcription_keyboard(
    state: TranscriptionState,
    has_segments: bool,
    settings: Settings
) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞—Ç—å inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è."""
    pass

def encode_callback_data(
    action: str,
    usage_id: int,
    **params
) -> str:
    """–ö–æ–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ callback_data (–º–∞–∫—Å 64 –±–∞–π—Ç–∞)."""
    # –§–æ—Ä–º–∞—Ç: "action:usage_id:param1=val1,param2=val2"
    pass

def decode_callback_data(data: str) -> dict:
    """–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å callback_data –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å–ª–æ–≤–∞—Ä—å."""
    pass
```

#### `src/services/text_processor.py`
```python
from src.services.llm_service import LLMService
from src.storage.models import TranscriptionVariant

class TextProcessor:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —á–µ—Ä–µ–∑ LLM."""

    def __init__(self, llm_service: LLMService):
        self.llm = llm_service

    async def create_structured(
        self,
        original_text: str,
        length_level: str = "default"
    ) -> str:
        """–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç (–∞–±–∑–∞—Ü—ã, –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è, —Å–ø–∏—Å–∫–∏)."""
        pass

    async def create_summary(
        self,
        original_text: str,
        length_level: str = "default"
    ) -> str:
        """–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑—é–º–µ '–û —á–µ–º —Ç–µ–∫—Å—Ç?'."""
        pass

    async def adjust_length(
        self,
        current_text: str,
        direction: str,  # "shorter" or "longer"
        current_level: str
    ) -> str:
        """–ò–∑–º–µ–Ω–∏—Ç—å –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ (¬±20%)."""
        pass

    async def add_emojis(
        self,
        text: str,
        emoji_level: int
    ) -> str:
        """–î–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç."""
        pass

    def format_with_timestamps(
        self,
        segments: list,
        base_text: str
    ) -> str:
        """–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∫–æ–¥—ã –≤ —Ç–µ–∫—Å—Ç –∏–∑ —Å–µ–≥–º–µ–Ω—Ç–æ–≤."""
        # –§–æ—Ä–º–∞—Ç: [00:15] –¢–µ–∫—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞...
        pass
```

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–æ —Ñ–∞–∑–∞–º

### **–§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞** (2-3 –¥–Ω—è)

**–¶–µ–ª–∏:**
- –°–æ–∑–¥–∞—Ç—å –ë–î –º–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å segments –∏–∑ faster-whisper
- –ë–∞–∑–æ–≤—ã–π callback query handler
- Feature flags –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- –û–¥–∏–Ω —Ä–µ–∂–∏–º: "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç" (–∫–Ω–æ–ø–∫–∞-–∑–∞–≥–ª—É—à–∫–∞)

**–®–∞–≥–∏:**

1. **Database Schema** (4-6 —á–∞—Å–æ–≤)
   - [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª–∏ `TranscriptionState`, `TranscriptionSegment`, `TranscriptionVariant` –≤ `src/storage/models.py`
   - [ ] –°–æ–∑–¥–∞—Ç—å Alembic –º–∏–≥—Ä–∞—Ü–∏—é
   - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ: `alembic upgrade head`
   - [ ] –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤ `src/storage/repositories.py`:
     - `TranscriptionStateRepository`
     - `TranscriptionSegmentRepository`
     - `TranscriptionVariantRepository`

2. **Feature Flags** (2-3 —á–∞—Å–∞)
   - [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥–∏ –≤ `src/config.py`:
     ```python
     # Interactive Features
     interactive_mode_enabled: bool = Field(default=False)
     enable_structured_mode: bool = Field(default=False)
     enable_summary_mode: bool = Field(default=False)
     enable_emoji_option: bool = Field(default=False)
     enable_timestamps_option: bool = Field(default=False)
     enable_length_variations: bool = Field(default=False)
     enable_retranscribe: bool = Field(default=False)

     # Limits
     max_cached_variants_per_transcription: int = Field(default=10)
     variant_cache_ttl_days: int = Field(default=7)
     timestamps_min_duration: int = Field(default=300)  # 5 –º–∏–Ω—É—Ç
     ```
   - [ ] –û–±–Ω–æ–≤–∏—Ç—å `.env.example` —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π —Ñ–ª–∞–≥–æ–≤

3. **Segments —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** (3-4 —á–∞—Å–∞)
   - [ ] –ò–∑–º–µ–Ω–∏—Ç—å `src/transcription/providers/faster_whisper_provider.py`:
     - –í–µ—Ä–Ω—É—Ç—å segments –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º –≤ `TranscriptionResult`
     - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `segments: list[dict]` –≤ `TranscriptionResult`
   - [ ] –ò–∑–º–µ–Ω–∏—Ç—å `src/transcription/models.py`:
     ```python
     @dataclass
     class TranscriptionSegment:
         start: float
         end: float
         text: str

     @dataclass
     class TranscriptionResult:
         # ... existing fields ...
         segments: Optional[list[TranscriptionSegment]] = None
     ```
   - [ ] –°–æ—Ö—Ä–∞–Ω—è—Ç—å segments –≤ –ë–î –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (`src/bot/handlers.py`)

4. **–ë–∞–∑–æ–≤—ã–π Callback Handler** (4-5 —á–∞—Å–æ–≤)
   - [ ] –°–æ–∑–¥–∞—Ç—å `src/bot/callbacks.py`:
     ```python
     class CallbackHandlers:
         async def handle_callback_query(self, update: Update, context):
             """–†–æ—É—Ç–µ—Ä –¥–ª—è –≤—Å–µ—Ö callback queries."""
             query = update.callback_query
             await query.answer()  # Acknowledge

             data = decode_callback_data(query.data)
             action = data['action']

             if action == 'mode':
                 await self.handle_mode_change(update, context)
             # ... –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
     ```
   - [ ] –°–æ–∑–¥–∞—Ç—å `src/bot/keyboards.py`:
     ```python
     def create_transcription_keyboard(state, has_segments, settings):
         keyboard = []

         # –†—è–¥ 1: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ interactive_mode_enabled)
         if settings.interactive_mode_enabled:
             label = "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (–≤—ã –∑–¥–µ—Å—å)" if state.active_mode == "original" else "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç"
             keyboard.append([
                 InlineKeyboardButton(
                     label,
                     callback_data=encode_callback_data("mode", state.usage_id, mode="original")
                 )
             ])

         return InlineKeyboardMarkup(keyboard) if keyboard else None
     ```
   - [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å handler –≤ `src/main.py`:
     ```python
     from telegram.ext import CallbackQueryHandler

     callback_handlers = CallbackHandlers(...)
     application.add_handler(CallbackQueryHandler(callback_handlers.handle_callback_query))
     ```

5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å handlers** (3-4 —á–∞—Å–∞)
   - [ ] –ò–∑–º–µ–Ω–∏—Ç—å `src/bot/handlers.py`:
     - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Å–æ–∑–¥–∞—Ç—å `TranscriptionState`
     - –î–æ–±–∞–≤–∏—Ç—å inline –∫–Ω–æ–ø–∫–∏ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
     - –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (>4096): —Å–æ–∑–¥–∞—Ç—å –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
   - [ ] –°–æ—Ö—Ä–∞–Ω—è—Ç—å segments –µ—Å–ª–∏ `duration > timestamps_min_duration`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 1:**
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ Segments —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∞—É–¥–∏–æ (>5 –º–∏–Ω)
- ‚úÖ –ü–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç"
- ‚úÖ –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç (–∑–∞–≥–ª—É—à–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ Feature flag `INTERACTIVE_MODE_ENABLED=false` —É–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∫–Ω–æ–ø–∫–∏
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# 2. –¢–µ—Å—Ç 1: –ö–æ—Ä–æ—Ç–∫–æ–µ –∞—É–¥–∏–æ (<5 –º–∏–Ω)
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ 30 —Å–µ–∫
# –û–∂–∏–¥–∞–Ω–∏–µ: –ö–Ω–æ–ø–∫–∞ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç" –ø–æ—è–≤–ª—è–µ—Ç—Å—è, segments –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

# 3. –¢–µ—Å—Ç 2: –î–ª–∏–Ω–Ω–æ–µ –∞—É–¥–∏–æ (>5 –º–∏–Ω)
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å 6-–º–∏–Ω—É—Ç–Ω–æ–µ –∞—É–¥–∏–æ
# –û–∂–∏–¥–∞–Ω–∏–µ: –ö–Ω–æ–ø–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è, segments —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î

# 4. –¢–µ—Å—Ç 3: Feature flag
# .env: INTERACTIVE_MODE_ENABLED=false
# –û–∂–∏–¥–∞–Ω–∏–µ: –ö–Ω–æ–ø–æ–∫ –Ω–µ—Ç –≤–æ–æ–±—â–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
sqlite3 data/bot.db "SELECT * FROM transcription_states LIMIT 1;"
sqlite3 data/bot.db "SELECT COUNT(*) FROM transcription_segments;"
```

---

### **–§–∞–∑–∞ 2: –†–µ–∂–∏–º "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"** (2-3 –¥–Ω—è)

**–¶–µ–ª–∏:**
- LLM –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (–±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ "–ò—Å—Ö–æ–¥–Ω—ã–π" ‚Üî "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"

**–®–∞–≥–∏:**

1. **TextProcessor —Å–µ—Ä–≤–∏—Å** (4-5 —á–∞—Å–æ–≤)
   - [ ] –°–æ–∑–¥–∞—Ç—å `src/services/text_processor.py`
   - [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `create_structured()`:
     ```python
     async def create_structured(self, original_text: str, length_level: str = "default") -> str:
         if length_level != "default":
             raise NotImplementedError("Length variations in Phase 3")

         prompt = """
         –¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.

         –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (—Å—ã—Ä–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è):
         {text}

         –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
         1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏ –æ–ø–µ—á–∞—Ç–∫–∏
         2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
         3. –†–∞–∑–±–∏—Ç—å –Ω–∞ –∞–±–∑–∞—Ü—ã –ø–æ —Å–º—ã—Å–ª—É
         4. –í—ã–¥–µ–ª–∏—Ç—å —Å–ø–∏—Å–∫–∏ –±—É–ª–ª–µ—Ç–∞–º–∏ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ (‚Ä¢)
         5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å—å —Å–º—ã—Å–ª –∏ –≤—Å–µ –¥–µ—Ç–∞–ª–∏
         6. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è
         7. –ù–ï —Å–æ–∫—Ä–∞—â–∞—Ç—å (—ç—Ç–æ –Ω–µ —Ä–µ–∑—é–º–µ)

         –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
         """

         result = await self.llm.refine_transcription(
             original_text,
             prompt=prompt.format(text=original_text)
         )
         return result
     ```

2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤** (3-4 —á–∞—Å–∞)
   - [ ] –í `src/storage/repositories.py`:
     ```python
     class TranscriptionVariantRepository:
         async def get_variant(
             self,
             usage_id: int,
             mode: str,
             length_level: str = "default",
             emoji_level: int = 0,
             timestamps_enabled: bool = False
         ) -> Optional[TranscriptionVariant]:
             """–ü–æ–ª—É—á–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ –∫—ç—à–∞."""
             pass

         async def save_variant(
             self,
             usage_id: int,
             mode: str,
             text_content: str,
             length_level: str = "default",
             emoji_level: int = 0,
             timestamps_enabled: bool = False,
             generated_by: str = "llm",
             llm_model: Optional[str] = None,
             processing_time: Optional[float] = None
         ) -> TranscriptionVariant:
             """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç."""
             pass

         async def cleanup_old_variants(self, ttl_days: int) -> int:
             """–£–¥–∞–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å—Ç–∞—Ä—à–µ TTL."""
             pass
     ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CallbackHandlers** (5-6 —á–∞—Å–æ–≤)
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     async def handle_mode_change(self, update: Update, context):
         query = update.callback_query
         data = decode_callback_data(query.data)

         usage_id = data['usage_id']
         new_mode = data['mode']

         # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
         state = await state_repo.get_by_usage_id(usage_id)

         # –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ Usage
         usage = await usage_repo.get_by_id(usage_id)
         original_text = usage.get_original_text()  # –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ

         # –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
         variant = await variant_repo.get_variant(usage_id, new_mode)

         if not variant:
             # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
             if new_mode == "structured":
                 text = await text_processor.create_structured(original_text)
                 variant = await variant_repo.save_variant(
                     usage_id, new_mode, text,
                     generated_by="llm",
                     llm_model=settings.llm_model
                 )

         # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
         state.active_mode = new_mode
         await state_repo.update(state)

         # –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
         keyboard = create_transcription_keyboard(state, has_segments, settings)

         # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
         if state.is_file_message:
             # –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª (–§–∞–∑–∞ 7)
             pass
         else:
             await query.edit_message_text(
                 text=variant.text_content,
                 reply_markup=keyboard
             )
     ```

4. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É** (2 —á–∞—Å–∞)
   - [ ] –í `src/bot/keyboards.py`:
     ```python
     # –†—è–¥ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å
     if settings.enable_structured_mode:
         label = "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å (–≤—ã –∑–¥–µ—Å—å)" if state.active_mode == "structured" else "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
         keyboard.append([
             InlineKeyboardButton(
                 label,
                 callback_data=encode_callback_data("mode", state.usage_id, mode="structured")
             )
         ])
     ```

5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞** (1-2 —á–∞—Å–∞)
   - [ ] –ü—Ä–æ–±–ª–µ–º–∞: –°–µ–π—á–∞—Å –≤ `Usage` —Ç–æ–ª—å–∫–æ `transcription_length`, –∞ –Ω–µ —Å–∞–º —Ç–µ–∫—Å—Ç
   - [ ] –†–µ—à–µ–Ω–∏–µ: –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –≤–∞—Ä–∏–∞–Ω—Ç —Å `mode=original`:
     ```python
     # –í handlers.py –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:
     await variant_repo.save_variant(
         usage_id=usage.id,
         mode="original",
         text_content=transcription_text,
         generated_by="transcription"
     )
     ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 2:**
- ‚úÖ –ü–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å" (–µ—Å–ª–∏ —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω)
- ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ LLM
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –±–µ—Ä—ë—Ç –∏–∑ –∫—ç—à–∞ (–±—ã—Å—Ç—Ä–æ)
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç" —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "(–≤—ã –∑–¥–µ—Å—å)" –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
- ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –í–∫–ª—é—á–∏—Ç—å feature flag
# .env: ENABLE_STRUCTURED_MODE=true

# 2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
# –û–∂–∏–¥–∞–Ω–∏–µ: –î–≤–µ –∫–Ω–æ–ø–∫–∏: "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (–≤—ã –∑–¥–µ—Å—å)" –∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"

# 3. –ù–∞–∂–∞—Ç—å "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
# –û–∂–∏–¥–∞–Ω–∏–µ: –¢–µ–∫—Å—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è, –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞–ª–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å (–≤—ã –∑–¥–µ—Å—å)"

# 4. –ù–∞–∂–∞—Ç—å "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç"
# –û–∂–∏–¥–∞–Ω–∏–µ: –í–µ—Ä–Ω—É–ª—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç

# 5. –°–Ω–æ–≤–∞ –Ω–∞–∂–∞—Ç—å "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
# –û–∂–∏–¥–∞–Ω–∏–µ: –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç (–∏–∑ –∫—ç—à–∞), —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
sqlite3 data/bot.db "SELECT mode, generated_by FROM transcription_variants WHERE usage_id=X;"
# –û–∂–∏–¥–∞–Ω–∏–µ: original (transcription), structured (llm)
```

---

### **–§–∞–∑–∞ 3: –í–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª–∏–Ω—ã** (2 –¥–Ω—è)

**–¶–µ–ª–∏:**
- –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ (1 ‚Üí 3 –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ–∂–∏–º–∞)
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (short –æ—Ç default, shorter –æ—Ç short)

**–®–∞–≥–∏:**

1. **–ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –¥–ª–∏–Ω—ã** (3-4 —á–∞—Å–∞)
   - [ ] –í `src/services/text_processor.py`:
     ```python
     async def adjust_length(
         self,
         current_text: str,
         direction: str,  # "shorter" or "longer"
         current_level: str,
         mode: str  # "structured" or "summary"
     ) -> str:
         if direction == "shorter":
             prompt = """
             –¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 20%, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

             –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç ({mode}):
             {text}

             –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
             1. –£–±—Ä–∞—Ç—å –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
             2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–º—ã—Å–ª
             3. –°–æ–∫—Ä–∞—Ç–∏—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 20% –ø–æ –¥–ª–∏–Ω–µ
             4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏)
             5. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–∏—á–µ–≥–æ –Ω–æ–≤–æ–≥–æ

             –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Å–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
             """
         else:  # longer
             prompt = """
             –¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 20%, –¥–æ–±–∞–≤–ª—è—è –¥–µ—Ç–∞–ª–∏.

             –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç ({mode}):
             {text}

             –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
             1. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º—ã—Å–ª–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ
             2. –î–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏—è –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ
             3. –£–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 20% –ø–æ –¥–ª–∏–Ω–µ
             4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Å–º—ã—Å–ª
             5. –ù–ï –≤—ã–¥—É–º—ã–≤–∞—Ç—å —Ñ–∞–∫—Ç—ã

             –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
             """

         result = await self.llm.refine_transcription(
             current_text,
             prompt=prompt.format(mode=mode, text=current_text)
         )
         return result
     ```

2. **–õ–æ–≥–∏–∫–∞ —É—Ä–æ–≤–Ω–µ–π** (2-3 —á–∞—Å–∞)
   - [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫: shorter ‚Üê short ‚Üê default ‚Üí long ‚Üí longer
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     LEVEL_TRANSITIONS = {
         "default": {"shorter": "short", "longer": "long"},
         "short": {"shorter": "shorter", "longer": "default"},
         "shorter": {"longer": "short"},  # –ù–µ—Ç –¥–∞–ª—å—à–µ shorter
         "long": {"shorter": "default", "longer": "longer"},
         "longer": {"shorter": "long"},  # –ù–µ—Ç –¥–∞–ª—å—à–µ longer
     }

     async def handle_length_change(self, update: Update, context):
         query = update.callback_query
         data = decode_callback_data(query.data)

         usage_id = data['usage_id']
         direction = data['direction']  # "shorter" or "longer"

         state = await state_repo.get_by_usage_id(usage_id)
         current_level = state.length_level

         # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
         if direction not in LEVEL_TRANSITIONS[current_level]:
             await query.answer("–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ø—Ä–µ–¥–µ–ª!", show_alert=True)
             return

         new_level = LEVEL_TRANSITIONS[current_level][direction]

         # –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
         variant = await variant_repo.get_variant(
             usage_id, state.active_mode, new_level, state.emoji_level, state.timestamps_enabled
         )

         if not variant:
             # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç (–±–∞–∑—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è)
             current_variant = await variant_repo.get_variant(
                 usage_id, state.active_mode, current_level, state.emoji_level, state.timestamps_enabled
             )

             # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
             new_text = await text_processor.adjust_length(
                 current_variant.text_content,
                 direction,
                 current_level,
                 state.active_mode
             )

             variant = await variant_repo.save_variant(
                 usage_id, state.active_mode, new_text,
                 length_level=new_level,
                 emoji_level=state.emoji_level,
                 timestamps_enabled=state.timestamps_enabled,
                 generated_by="llm"
             )

         # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
         state.length_level = new_level
         await state_repo.update(state)

         # –û–±–Ω–æ–≤–∏—Ç—å UI
         keyboard = create_transcription_keyboard(state, has_segments, settings)
         await query.edit_message_text(variant.text_content, reply_markup=keyboard)
     ```

3. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏** (3-4 —á–∞—Å–∞)
   - [ ] –í `src/bot/keyboards.py`:
     ```python
     # –†—è–¥ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å
     if settings.enable_structured_mode:
         if state.active_mode == "structured" and settings.enable_length_variations:
             # 3 –∫–Ω–æ–ø–∫–∏: –ö–æ—Ä–æ—á–µ | üìù | –î–ª–∏–Ω–Ω–µ–µ
             row = []

             # –ö–Ω–æ–ø–∫–∞ "–ö–æ—Ä–æ—á–µ"
             if state.length_level in ["short", "default", "long", "longer"]:
                 row.append(InlineKeyboardButton(
                     "–ö–æ—Ä–æ—á–µ",
                     callback_data=encode_callback_data("length", state.usage_id, direction="shorter")
                 ))

             # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä (–Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π)
             level_emoji = {
                 "shorter": "üìù-",
                 "short": "üìù‚Üì",
                 "default": "üìù",
                 "long": "üìù‚Üë",
                 "longer": "üìù+"
             }
             row.append(InlineKeyboardButton(
                 level_emoji[state.length_level],
                 callback_data="noop"  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ
             ))

             # –ö–Ω–æ–ø–∫–∞ "–î–ª–∏–Ω–Ω–µ–µ"
             if state.length_level in ["shorter", "short", "default", "long"]:
                 row.append(InlineKeyboardButton(
                     "–î–ª–∏–Ω–Ω–µ–µ",
                     callback_data=encode_callback_data("length", state.usage_id, direction="longer")
                 ))

             keyboard.append(row)
         else:
             # –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞
             label = "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å (–≤—ã –∑–¥–µ—Å—å)" if state.active_mode == "structured" else "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
             keyboard.append([InlineKeyboardButton(
                 label,
                 callback_data=encode_callback_data("mode", state.usage_id, mode="structured")
             )])
     ```

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ "noop"** (0.5 —á–∞—Å–∞)
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     async def handle_callback_query(self, update: Update, context):
         query = update.callback_query

         if query.data == "noop":
             await query.answer()  # –ü—Ä–æ—Å—Ç–æ acknowledge, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
             return

         # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
     ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 3:**
- ‚úÖ –ü—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ–∂–∏–º–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å" –ø–æ—è–≤–ª—è—é—Ç—Å—è 3 –∫–Ω–æ–ø–∫–∏
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ö–æ—Ä–æ—á–µ" –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–î–ª–∏–Ω–Ω–µ–µ" –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
- ‚úÖ –ù–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö (shorter/longer) –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ disabled
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä) –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∫–ª–∏–∫–∏
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç" —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–∞ 1 –∫–Ω–æ–ø–∫—É

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –í–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥–∏
# .env: ENABLE_STRUCTURED_MODE=true, ENABLE_LENGTH_VARIATIONS=true

# 2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
# –û–∂–∏–¥–∞–Ω–∏–µ: –¢—Ä–∏ –∫–Ω–æ–ø–∫–∏: [–ö–æ—Ä–æ—á–µ] [üìù] [–î–ª–∏–Ω–Ω–µ–µ]

# 3. –ù–∞–∂–∞—Ç—å "–ö–æ—Ä–æ—á–µ"
# –û–∂–∏–¥–∞–Ω–∏–µ: –¢–µ–∫—Å—Ç –∫–æ—Ä–æ—á–µ, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä [üìù‚Üì], –¥–æ—Å—Ç—É–ø–Ω—ã –æ–±–µ –∫–Ω–æ–ø–∫–∏

# 4. –ù–∞–∂–∞—Ç—å "–ö–æ—Ä–æ—á–µ" —Å–Ω–æ–≤–∞
# –û–∂–∏–¥–∞–Ω–∏–µ: –ï—â—ë –∫–æ—Ä–æ—á–µ, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä [üìù-], –∫–Ω–æ–ø–∫–∞ "–ö–æ—Ä–æ—á–µ" –∏—Å—á–µ–∑–ª–∞

# 5. –ù–∞–∂–∞—Ç—å "–î–ª–∏–Ω–Ω–µ–µ" –¥–≤–∞–∂–¥—ã
# –û–∂–∏–¥–∞–Ω–∏–µ: –í–µ—Ä–Ω—É–ª–∏—Å—å –∫ default [üìù]

# 6. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç"
# –û–∂–∏–¥–∞–Ω–∏–µ: –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (–≤—ã –∑–¥–µ—Å—å)"
```

---

### **–§–∞–∑–∞ 4: –†–µ–∂–∏–º "–û —á–µ–º —Ç–µ–∫—Å—Ç?"** (1-2 –¥–Ω—è)

**–¶–µ–ª–∏:**
- LLM –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑—é–º–µ
- –¢—Ä–µ—Ç–∏–π —Ä–µ–∂–∏–º —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –¥–ª–∏–Ω—ã
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Ç—Ä–µ–º—è —Ä–µ–∂–∏–º–∞–º–∏

**–®–∞–≥–∏:**

1. **–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–∑—é–º–µ** (2-3 —á–∞—Å–∞)
   - [ ] –í `src/services/text_processor.py`:
     ```python
     async def create_summary(
         self,
         original_text: str,
         length_level: str = "default"
     ) -> str:
         if length_level == "default":
             prompt = """
             –¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç–µ–∫—Å—Ç–∞, –æ—Ç–≤–µ—á–∞—è –Ω–∞ –≤–æ–ø—Ä–æ—Å "–û —á–µ–º —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç?"

             –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:
             {text}

             –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
             1. –í—ã–¥–µ–ª–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Ç–µ–º—É/–∏–¥–µ—é
             2. –ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã (3-5 –ø—É–Ω–∫—Ç–æ–≤)
             3. –û–±—ä—ë–º: –ø—Ä–∏–º–µ—Ä–Ω–æ 25-30% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
             4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∫—Ä–∞—Ç–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ + –±—É–ª–ª–µ—Ç—ã
             5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
             6. –ù–ï –≤—ã–¥—É–º—ã–≤–∞—Ç—å

             –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
             –û —á–µ–º —Ç–µ–∫—Å—Ç: <–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã>

             –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:
             ‚Ä¢ <–ø—É–Ω–∫—Ç 1>
             ‚Ä¢ <–ø—É–Ω–∫—Ç 2>
             ‚Ä¢ ...

             –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ä–µ–∑—é–º–µ –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
             """
         elif length_level in ["short", "shorter"]:
             # –ë–æ–ª–µ–µ –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
             prompt = """... –µ—â—ë –∫–æ—Ä–æ—á–µ, 2-3 –ø—É–Ω–∫—Ç–∞, 15-20% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ ..."""
         else:  # long, longer
             # –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ–∑—é–º–µ
             prompt = """... –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ, 5-7 –ø—É–Ω–∫—Ç–æ–≤, 35-40% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ ..."""

         result = await self.llm.refine_transcription(
             original_text,
             prompt=prompt.format(text=original_text)
         )
         return result
     ```

2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏** (1 —á–∞—Å)
   - [ ] –í `src/bot/keyboards.py`:
     ```python
     # –†—è–¥ 3: –û —á–µ–º —Ç–µ–∫—Å—Ç?
     if settings.enable_summary_mode:
         if state.active_mode == "summary" and settings.enable_length_variations:
             # 3 –∫–Ω–æ–ø–∫–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ structured
             row = []
             if state.length_level in ["short", "default", "long", "longer"]:
                 row.append(InlineKeyboardButton("–ö–æ—Ä–æ—á–µ", ...))
             row.append(InlineKeyboardButton("üí°" if state.active_mode=="summary" else "üìã", ...))
             if state.length_level in ["shorter", "short", "default", "long"]:
                 row.append(InlineKeyboardButton("–î–ª–∏–Ω–Ω–µ–µ", ...))
             keyboard.append(row)
         else:
             label = "–û —á–µ–º —Ç–µ–∫—Å—Ç? (–≤—ã –∑–¥–µ—Å—å)" if state.active_mode == "summary" else "–û —á–µ–º —Ç–µ–∫—Å—Ç?"
             keyboard.append([InlineKeyboardButton(label, ...)])
     ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ handle_mode_change** (1 —á–∞—Å)
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     # –í handle_mode_change –¥–æ–±–∞–≤–∏—Ç—å —Å–ª—É—á–∞–π "summary":
     if new_mode == "summary":
         text = await text_processor.create_summary(original_text, state.length_level)
         # ... —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞
     ```

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤** (2-3 —á–∞—Å–∞)
   - [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—é–º–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–∫—Å—Ç–∞—Ö
   - [ ] –¢—é–Ω–∏–Ω–≥ –ø—Ä–æ–º–ø—Ç–æ–≤ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 4:**
- ‚úÖ –ü–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–û —á–µ–º —Ç–µ–∫—Å—Ç?"
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–û —á–µ–º + –±—É–ª–ª–µ—Ç—ã"
- ‚úÖ –í–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç (–∫–æ—Ä–æ—á–µ/–¥–ª–∏–Ω–Ω–µ–µ)
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤—Å–µ–º–∏ 3 —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ length_level —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ default

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –í–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥
# .env: ENABLE_SUMMARY_MODE=true

# 2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å "–û —á–µ–º —Ç–µ–∫—Å—Ç?"
# –û–∂–∏–¥–∞–Ω–∏–µ: –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Å –±—É–ª–ª–µ—Ç–∞–º–∏

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞—Ä–∏–∞—Ü–∏–∏ –¥–ª–∏–Ω—ã
# –û–∂–∏–¥–∞–Ω–∏–µ: –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤ —Ä–µ–∂–∏–º–µ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"

# 4. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏
# –û–∂–∏–¥–∞–Ω–∏–µ: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å–º–µ–Ω–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–Ω–æ–ø–æ–∫
```

---

### **–§–∞–∑–∞ 5: –û–ø—Ü–∏—è "–°–º–∞–π–ª—ã"** (1-2 –¥–Ω—è)

**–¶–µ–ª–∏:**
- –ü—Ä–æ–º–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏
- 3 —É—Ä–æ–≤–Ω—è (0 / 1-2 emoji / 3-5 emoji)
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ª—é–±–æ–º—É –∞–∫—Ç–∏–≤–Ω–æ–º—É —Ä–µ–∂–∏–º—É

**–®–∞–≥–∏:**

1. **–ü—Ä–æ–º–ø—Ç –¥–ª—è —Å–º–∞–π–ª–æ–≤** (2 —á–∞—Å–∞)
   - [ ] –í `src/services/text_processor.py`:
     ```python
     async def add_emojis(self, text: str, emoji_level: int) -> str:
         if emoji_level == 1:
             prompt = """
             –î–æ–±–∞–≤—å 1-2 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç.

             –¢–µ–∫—Å—Ç:
             {text}

             –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
             1. –≠–º–æ–¥–∑–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞—Ç—å —Å–º—ã—Å–ª
             2. –†–∞–∑–º–µ—â–∞—Ç—å –≤ –Ω–∞—á–∞–ª–µ –∞–±–∑–∞—Ü–µ–≤ –∏–ª–∏ –ø–µ—Ä–µ–¥ –≤–∞–∂–Ω—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏
             3. –ù–µ –ø–µ—Ä–µ–±–æ—Ä—â–∏—Ç—å: 1-2 emoji –Ω–∞ –≤–µ—Å—å —Ç–µ–∫—Å—Ç
             4. –ù–ï –º–µ–Ω—è—Ç—å —Å–∞–º —Ç–µ–∫—Å—Ç

             –í–µ—Ä–Ω–∏ —Ç–µ–∫—Å—Ç —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —ç–º–æ–¥–∑–∏.
             """
         elif emoji_level == 2:
             prompt = """
             –î–æ–±–∞–≤—å 3-5 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç.

             –¢–µ–∫—Å—Ç:
             {text}

             –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
             1. –≠–º–æ–¥–∑–∏ —É—Å–∏–ª–∏–≤–∞—é—Ç –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ
             2. –†–∞–∑–º–µ—â–∞—Ç—å –ø–µ—Ä–µ–¥ –∫–ª—é—á–µ–≤—ã–º–∏ –∏–¥–µ—è–º–∏
             3. –£–º–µ—Ä–µ–Ω–Ω–æ: 3-5 emoji –Ω–∞ —Ç–µ–∫—Å—Ç
             4. –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —ç–º–æ–¥–∑–∏
             5. –ù–ï –º–µ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç

             –í–µ—Ä–Ω–∏ —Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏.
             """
         else:
             return text  # Level 0 - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

         result = await self.llm.refine_transcription(text, prompt=prompt.format(text=text))
         return result
     ```

2. **Callback handler** (3-4 —á–∞—Å–∞)
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     async def handle_emoji_toggle(self, update: Update, context):
         query = update.callback_query
         data = decode_callback_data(query.data)

         usage_id = data['usage_id']
         direction = data.get('direction', 'increase')  # increase/decrease

         state = await state_repo.get_by_usage_id(usage_id)
         current_emoji = state.emoji_level

         # –í—ã—á–∏—Å–ª–∏—Ç—å –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
         if direction == "increase":
             new_emoji = min(current_emoji + 1, 2)
             if new_emoji == current_emoji:
                 await query.answer("–ë–æ–ª—å—à–µ —Å–º–∞–π–ª–æ–≤ –Ω–µ–ª—å–∑—è!", show_alert=True)
                 return
         else:  # decrease
             new_emoji = max(current_emoji - 1, 0)

         # –ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ —Å–º–∞–π–ª–æ–≤)
         base_variant = await variant_repo.get_variant(
             usage_id, state.active_mode, state.length_level, emoji_level=0, timestamps_enabled=state.timestamps_enabled
         )

         if new_emoji == 0:
             # –£–±—Ä–∞—Ç—å —Å–º–∞–π–ª—ã = –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –±–∞–∑–æ–≤–æ–º—É
             text = base_variant.text_content
         else:
             # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—ç—à
             variant = await variant_repo.get_variant(
                 usage_id, state.active_mode, state.length_level, new_emoji, state.timestamps_enabled
             )

             if not variant:
                 # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —ç–º–æ–¥–∑–∏
                 text = await text_processor.add_emojis(base_variant.text_content, new_emoji)
                 variant = await variant_repo.save_variant(
                     usage_id, state.active_mode, text,
                     length_level=state.length_level,
                     emoji_level=new_emoji,
                     timestamps_enabled=state.timestamps_enabled
                 )
             text = variant.text_content

         # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
         state.emoji_level = new_emoji
         await state_repo.update(state)

         # –û–±–Ω–æ–≤–∏—Ç—å UI
         keyboard = create_transcription_keyboard(state, has_segments, settings)
         await query.edit_message_text(text, reply_markup=keyboard)
     ```

3. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–º–∞–π–ª–æ–≤** (2-3 —á–∞—Å–∞)
   - [ ] –í `src/bot/keyboards.py`:
     ```python
     # –†—è–¥ 4: –°–º–∞–π–ª—ã
     if settings.enable_emoji_option:
         if state.emoji_level > 0:
             # 3 –∫–Ω–æ–ø–∫–∏: –ú–µ–Ω—å—à–µ/–£–±—Ä–∞—Ç—å | üòä | –ë–æ–ª—å—à–µ
             row = []

             # –ö–Ω–æ–ø–∫–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è
             label = "–£–±—Ä–∞—Ç—å" if state.emoji_level == 1 else "–ú–µ–Ω—å—à–µ"
             row.append(InlineKeyboardButton(
                 label,
                 callback_data=encode_callback_data("emoji", state.usage_id, direction="decrease")
             ))

             # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä
             emoji_indicator = ["üòä", "üòäüòä"][state.emoji_level - 1]
             row.append(InlineKeyboardButton(emoji_indicator, callback_data="noop"))

             # –ö–Ω–æ–ø–∫–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏—è
             if state.emoji_level < 2:
                 row.append(InlineKeyboardButton(
                     "–ë–æ–ª—å—à–µ",
                     callback_data=encode_callback_data("emoji", state.usage_id, direction="increase")
                 ))

             keyboard.append(row)
         else:
             # –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞
             keyboard.append([InlineKeyboardButton(
                 "üòä –°–º–∞–π–ª—ã",
                 callback_data=encode_callback_data("emoji", state.usage_id, direction="increase")
             )])
     ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 5:**
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üòä –°–º–∞–π–ª—ã" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
- ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è 1-2 —Å–º–∞–π–ª–∞ –≤ —Ç–µ–∫—Å—Ç–µ
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ "–ë–æ–ª—å—à–µ" –¥–æ–±–∞–≤–ª—è–µ—Ç 3-5 —Å–º–∞–π–ª–æ–≤
- ‚úÖ "–£–±—Ä–∞—Ç—å" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ —Ç–µ–∫—Å—Ç—É –±–µ–∑ —Å–º–∞–π–ª–æ–≤
- ‚úÖ –°–º–∞–π–ª—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —Ä–µ–∂–∏–º—É –∏ length_level
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç emoji_level

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –í–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥
# .env: ENABLE_EMOJI_OPTION=true

# 2. –í —Ä–µ–∂–∏–º–µ "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç" –Ω–∞–∂–∞—Ç—å "üòä –°–º–∞–π–ª—ã"
# –û–∂–∏–¥–∞–Ω–∏–µ: 1-2 emoji –¥–æ–±–∞–≤–ª–µ–Ω—ã, —Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ [–£–±—Ä–∞—Ç—å] [üòä] [–ë–æ–ª—å—à–µ]

# 3. –ù–∞–∂–∞—Ç—å "–ë–æ–ª—å—à–µ"
# –û–∂–∏–¥–∞–Ω–∏–µ: 3-5 emoji, –¥–≤–µ –∫–Ω–æ–ø–∫–∏ [–ú–µ–Ω—å—à–µ] [üòäüòä]

# 4. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å"
# –û–∂–∏–¥–∞–Ω–∏–µ: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –° —Å–º–∞–π–ª–∞–º–∏ (emoji_level —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è)

# 5. –£–±—Ä–∞—Ç—å —Å–º–∞–π–ª—ã
# –û–∂–∏–¥–∞–Ω–∏–µ: –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üòä –°–º–∞–π–ª—ã"
```

---

### **–§–∞–∑–∞ 6: –¢–∞–π–º–∫–æ–¥—ã** (2 –¥–Ω—è)

**–¶–µ–ª–∏:**
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ segments –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
- –û–ø—Ü–∏—è –≤–∫–ª/–≤—ã–∫–ª —Ç–∞–π–º–∫–æ–¥–æ–≤
- –†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∞—É–¥–∏–æ (>5 –º–∏–Ω)

**–®–∞–≥–∏:**

1. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º–∫–æ–¥–æ–≤** (3-4 —á–∞—Å–∞)
   - [ ] –í `src/services/text_processor.py`:
     ```python
     def format_with_timestamps(
         self,
         segments: list[TranscriptionSegment],
         base_text: str,
         mode: str
     ) -> str:
         """
         –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∫–æ–¥—ã –≤ —Ç–µ–∫—Å—Ç.

         –§–æ—Ä–º–∞—Ç:
         [00:15] –¢–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞...
         [01:23] –¢–µ–∫—Å—Ç –≤—Ç–æ—Ä–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞...
         """

         if mode == "summary":
             # –î–ª—è —Ä–µ–∑—é–º–µ: —Ç–æ–ª—å–∫–æ —Ç–∞–π–º–∫–æ–¥ –ø–µ—Ä–≤–æ–≥–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞
             return self._format_timestamps_summary(segments, base_text)
         else:
             # –î–ª—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ/—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ: –∫–∞–∂–¥—ã–π —Å–µ–≥–º–µ–Ω—Ç
             lines = []
             for seg in segments:
                 timestamp = self._format_time(seg.start_time)
                 lines.append(f"[{timestamp}] {seg.text}")
             return "\n".join(lines)

     def _format_time(self, seconds: float) -> str:
         """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—É–Ω–¥—ã –≤ MM:SS –∏–ª–∏ HH:MM:SS."""
         hours = int(seconds // 3600)
         minutes = int((seconds % 3600) // 60)
         secs = int(seconds % 60)

         if hours > 0:
             return f"{hours:02d}:{minutes:02d}:{secs:02d}"
         else:
             return f"{minutes:02d}:{secs:02d}"

     def _format_timestamps_summary(self, segments, summary_text):
         """
         –î–ª—è —Ä–µ–∑—é–º–µ: –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –±—É–ª–ª–µ—Ç—ã —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏.
         –≠—Ç–æ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞, –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ–π.
         """
         # –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∫–æ–¥ –ø–µ—Ä–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —Ä–µ–∑—é–º–µ
         first_timestamp = self._format_time(segments[0].start_time)
         return f"[{first_timestamp}] {summary_text}"
     ```

2. **Callback handler** (2-3 —á–∞—Å–∞)
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     async def handle_timestamps_toggle(self, update: Update, context):
         query = update.callback_query
         data = decode_callback_data(query.data)

         usage_id = data['usage_id']
         state = await state_repo.get_by_usage_id(usage_id)

         # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ segments?
         segments = await segment_repo.get_by_usage_id(usage_id)
         if not segments:
             await query.answer("–¢–∞–π–º–∫–æ–¥—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ –∞—É–¥–∏–æ", show_alert=True)
             return

         new_timestamps = not state.timestamps_enabled

         # –ü–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ —Ç–∞–π–º–∫–æ–¥–æ–≤)
         base_variant = await variant_repo.get_variant(
             usage_id, state.active_mode, state.length_level, state.emoji_level, timestamps_enabled=False
         )

         if new_timestamps:
             # –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∫–æ–¥—ã
             variant = await variant_repo.get_variant(
                 usage_id, state.active_mode, state.length_level, state.emoji_level, timestamps_enabled=True
             )

             if not variant:
                 # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ç–∞–π–º–∫–æ–¥–∞–º–∏
                 text = text_processor.format_with_timestamps(
                     segments, base_variant.text_content, state.active_mode
                 )
                 variant = await variant_repo.save_variant(
                     usage_id, state.active_mode, text,
                     length_level=state.length_level,
                     emoji_level=state.emoji_level,
                     timestamps_enabled=True,
                     generated_by="formatting"
                 )
             text = variant.text_content
         else:
             # –£–±—Ä–∞—Ç—å —Ç–∞–π–º–∫–æ–¥—ã
             text = base_variant.text_content

         # –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
         state.timestamps_enabled = new_timestamps
         await state_repo.update(state)

         # –û–±–Ω–æ–≤–∏—Ç—å UI
         keyboard = create_transcription_keyboard(state, has_segments=len(segments) > 0, settings)
         await query.edit_message_text(text, reply_markup=keyboard)
     ```

3. **–ö–Ω–æ–ø–∫–∞ —Ç–∞–π–º–∫–æ–¥–æ–≤** (1-2 —á–∞—Å–∞)
   - [ ] –í `src/bot/keyboards.py`:
     ```python
     # –†—è–¥ 5: –¢–∞–π–º–∫–æ–¥—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å segments)
     if settings.enable_timestamps_option and has_segments:
         label = "–£–±—Ä–∞—Ç—å —Ç–∞–π–º–∫–æ–¥—ã" if state.timestamps_enabled else "‚è± –¢–∞–π–º–∫–æ–¥—ã"
         keyboard.append([InlineKeyboardButton(
             label,
             callback_data=encode_callback_data("timestamps", state.usage_id)
         )])
     ```

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ segments –ø—Ä–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏** (1-2 —á–∞—Å–∞)
   - [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤ –§–∞–∑–µ 1 –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è segments –¥–ª—è –∞—É–¥–∏–æ >5 –º–∏–Ω
   - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `has_segments` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ `create_transcription_keyboard`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 6:**
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "‚è± –¢–∞–π–º–∫–æ–¥—ã" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å segments
- ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–∞–π–º–∫–æ–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ [MM:SS]
- ‚úÖ –¢–∞–π–º–∫–æ–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
- ‚úÖ "–£–±—Ä–∞—Ç—å —Ç–∞–π–º–∫–æ–¥—ã" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ —Ç–µ–∫—Å—Ç—É –±–µ–∑ –Ω–∏—Ö
- ‚úÖ Segments —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞—É–¥–∏–æ >5 –º–∏–Ω

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –ö–æ—Ä–æ—Ç–∫–æ–µ –∞—É–¥–∏–æ (<5 –º–∏–Ω)
# –û–∂–∏–¥–∞–Ω–∏–µ: –ö–Ω–æ–ø–∫–∞ "‚è± –¢–∞–π–º–∫–æ–¥—ã" –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

# 2. –î–ª–∏–Ω–Ω–æ–µ –∞—É–¥–∏–æ (>5 –º–∏–Ω)
# –û–∂–∏–¥–∞–Ω–∏–µ: –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

# 3. –ù–∞–∂–∞—Ç—å "‚è± –¢–∞–π–º–∫–æ–¥—ã"
# –û–∂–∏–¥–∞–Ω–∏–µ: –¢–µ–∫—Å—Ç —Å [MM:SS] –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Å–µ–≥–º–µ–Ω—Ç–æ–º

# 4. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ "–û —á–µ–º —Ç–µ–∫—Å—Ç?"
# –û–∂–∏–¥–∞–Ω–∏–µ: –¢–∞–π–º–∫–æ–¥ –≤ –Ω–∞—á–∞–ª–µ —Ä–µ–∑—é–º–µ

# 5. "–£–±—Ä–∞—Ç—å —Ç–∞–π–º–∫–æ–¥—ã"
# –û–∂–∏–¥–∞–Ω–∏–µ: –¢–µ–∫—Å—Ç –±–µ–∑ —Ç–∞–π–º–∫–æ–¥–æ–≤

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
sqlite3 data/bot.db "SELECT COUNT(*) FROM transcription_segments WHERE usage_id=X;"
```

---

### **–§–∞–∑–∞ 7: –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏** (1-2 –¥–Ω—è)

**–¶–µ–ª–∏:**
- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Ç–µ–∫—Å—Ç <4096 –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, >4096 –≤ —Ñ–∞–π–ª–µ
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ inline –∫–Ω–æ–ø–æ–∫ —Å —Ñ–∞–π–ª–∞–º–∏

**–®–∞–≥–∏:**

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞** (0.5 —á–∞—Å–∞)
   - [ ] –í `src/config.py`:
     ```python
     file_threshold_chars: int = Field(default=4096, description="–¢–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ñ–∞–π–ª–æ–º")
     ```

2. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤** (3-4 —á–∞—Å–∞)
   - [ ] –í `src/bot/handlers.py` –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:
     ```python
     async def send_transcription_result(
         self,
         chat_id: int,
         user_message_id: int,
         text: str,
         keyboard: InlineKeyboardMarkup,
         usage_id: int
     ) -> tuple[int, Optional[int]]:
         """
         –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.

         Returns:
             (message_id, file_message_id)
         """

         if len(text) <= settings.file_threshold_chars:
             # –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç - –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
             msg = await context.bot.send_message(
                 chat_id=chat_id,
                 text=text,
                 reply_to_message_id=user_message_id,
                 reply_markup=keyboard
             )
             return (msg.message_id, None)
         else:
             # –î–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç - –≤ —Ñ–∞–π–ª
             # –°–æ–æ–±—â–µ–Ω–∏–µ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + –∫–Ω–æ–ø–∫–∏
             msg1 = await context.bot.send_message(
                 chat_id=chat_id,
                 text="üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ—Ç–æ–≤–∞! –§–∞–π–ª –Ω–∏–∂–µ ‚Üì",
                 reply_to_message_id=user_message_id,
                 reply_markup=keyboard
             )

             # –°–æ–æ–±—â–µ–Ω–∏–µ 2: –§–∞–π–ª
             file_obj = io.BytesIO(text.encode('utf-8'))
             file_obj.name = f"transcription_{usage_id}.txt"

             msg2 = await context.bot.send_document(
                 chat_id=chat_id,
                 document=file_obj,
                 filename=file_obj.name,
                 caption=f"üìÑ –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤)"
             )

             return (msg1.message_id, msg2.message_id)
     ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ callbacks** (4-5 —á–∞—Å–æ–≤)
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     async def update_transcription_display(
         self,
         query: CallbackQuery,
         state: TranscriptionState,
         new_text: str,
         keyboard: InlineKeyboardMarkup
     ):
         """–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–∞–π–ª)."""

         if not state.is_file_message:
             # –ü—Ä–æ—Å—Ç–æ–π —Å–ª—É—á–∞–π: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
             await query.edit_message_text(new_text, reply_markup=keyboard)
         else:
             # –°–ª–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π: —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏
             chat_id = query.message.chat_id

             # 1. –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ (—Ä–µ–∂–∏–º –∏–∑–º–µ–Ω–∏–ª—Å—è)
             mode_label = {
                 "original": "–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç",
                 "structured": "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
                 "summary": "–†–µ–∑—é–º–µ"
             }[state.active_mode]

             await query.edit_message_text(
                 f"üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ—Ç–æ–≤–∞! –§–∞–π–ª –Ω–∏–∂–µ ‚Üì\n\n"
                 f"–†–µ–∂–∏–º: {mode_label}",
                 reply_markup=keyboard
             )

             # 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª
             if state.file_message_id:
                 try:
                     await context.bot.delete_message(chat_id, state.file_message_id)
                 except Exception as e:
                     logger.warning(f"Could not delete old file: {e}")

             # 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª
             file_obj = io.BytesIO(new_text.encode('utf-8'))
             file_obj.name = f"transcription_{state.usage_id}_{state.active_mode}.txt"

             new_file_msg = await context.bot.send_document(
                 chat_id=chat_id,
                 document=file_obj,
                 filename=file_obj.name,
                 caption=f"üìÑ {mode_label} ({len(new_text)} —Å–∏–º–≤–æ–ª–æ–≤)"
             )

             # 4. –û–±–Ω–æ–≤–∏—Ç—å state —Å –Ω–æ–≤—ã–º file_message_id
             state.file_message_id = new_file_msg.message_id
             await state_repo.update(state)
     ```

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ is_file_message –≤ state** (1 —á–∞—Å)
   - [ ] –í `src/bot/handlers.py` –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
     ```python
     # –°–æ–∑–¥–∞—Ç—å state
     message_id, file_message_id = await send_transcription_result(...)

     state = await state_repo.create(
         usage_id=usage.id,
         message_id=message_id,
         chat_id=chat_id,
         is_file_message=(file_message_id is not None),
         file_message_id=file_message_id
     )
     ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 7:**
- ‚úÖ –¢–µ–∫—Å—Ç ‚â§4096 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
- ‚úÖ –¢–µ–∫—Å—Ç >4096 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ —Ñ–∞–π–ª .txt
- ‚úÖ Inline –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ñ–∞–π–ª–∞–º–∏
- ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (—É–¥–∞–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π)
- ‚úÖ Caption —Ñ–∞–π–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∂–∏–º –∏ –¥–ª–∏–Ω—É

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –ö–æ—Ä–æ—Ç–∫–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (~1000 —Å–∏–º–≤–æ–ª–æ–≤)
# –û–∂–∏–¥–∞–Ω–∏–µ: –¢–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏

# 2. –î–ª–∏–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (>4096 —Å–∏–º–≤–æ–ª–æ–≤)
# –û–∂–∏–¥–∞–Ω–∏–µ: –î–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è+–∫–Ω–æ–ø–∫–∏, –∑–∞—Ç–µ–º —Ñ–∞–π–ª

# 3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º (—Ñ–∞–π–ª)
# –û–∂–∏–¥–∞–Ω–∏–µ: –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω, –Ω–æ–≤—ã–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

# 4. –î–æ–±–∞–≤–∏—Ç—å —Å–º–∞–π–ª—ã (—Ñ–∞–π–ª)
# –û–∂–∏–¥–∞–Ω–∏–µ: –§–∞–π–ª –æ–±–Ω–æ–≤–ª—ë–Ω —Å —ç–º–æ–¥–∑–∏
```

---

### **–§–∞–∑–∞ 8: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è** (2-3 –¥–Ω—è)

**–¶–µ–ª–∏:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞
- –ö–Ω–æ–ø–∫–∞ "‚ö° –ú–æ–≥—É –ª—É—á—à–µ" —Å –¥–≤—É–º—è –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
- –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏

**–®–∞–≥–∏:**

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞** (3-4 —á–∞—Å–∞)
   - [ ] –î–æ–±–∞–≤–∏—Ç—å –≤ `Usage` –º–æ–¥–µ–ª—å:
     ```python
     # –í src/storage/models.py
     class Usage(Base):
         # ... existing fields ...

         # Original file path for retranscription
         original_file_path: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)
     ```
   - [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è
   - [ ] –í `src/bot/handlers.py`:
     ```python
     # –ü–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:
     # –í–º–µ—Å—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

     persistent_dir = Path(settings.persistent_audio_dir)  # NEW config
     persistent_dir.mkdir(exist_ok=True)

     permanent_path = persistent_dir / f"{usage.id}_{file_id}.ogg"
     shutil.copy(temp_audio_file, permanent_path)

     # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—É—Ç—å –≤ Usage
     usage.original_file_path = str(permanent_path)
     await usage_repo.update(usage)
     ```

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è** (1 —á–∞—Å)
   - [ ] –í `src/config.py`:
     ```python
     # File storage
     persistent_audio_dir: str = Field(
         default="./data/audio_files",
         description="Directory for storing audio files for retranscription"
     )
     persistent_audio_ttl_days: int = Field(
         default=7,
         description="How long to keep audio files"
     )

     # Retranscription options
     retranscribe_quality_model: str = Field(default="medium")  # –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º medium
     retranscribe_paid_provider: str = Field(default="openai")
     retranscribe_paid_cost_per_minute: float = Field(default=1.0)  # —Ä—É–±–ª–µ–π
     ```

3. **–ö–Ω–æ–ø–∫–∞ "–ú–æ–≥—É –ª—É—á—à–µ"** (2 —á–∞—Å–∞)
   - [ ] –í `src/bot/keyboards.py`:
     ```python
     # –†—è–¥ 6: –ú–æ–≥—É –ª—É—á—à–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ enable_retranscribe)
     if settings.enable_retranscribe:
         keyboard.append([InlineKeyboardButton(
             "‚ö° –ú–æ–≥—É –ª—É—á—à–µ",
             callback_data=encode_callback_data("retranscribe_menu", state.usage_id)
         )])
     ```

4. **–ü–æ–¥–º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞** (3-4 —á–∞—Å–∞)
   - [ ] –í `src/bot/callbacks.py`:
     ```python
     async def handle_retranscribe_menu(self, update: Update, context):
         """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ —Ä–µ—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏."""
         query = update.callback_query
         data = decode_callback_data(query.data)

         usage_id = data['usage_id']
         usage = await usage_repo.get_by_id(usage_id)

         # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª?
         if not usage.original_file_path or not Path(usage.original_file_path).exists():
             await query.answer("–§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏", show_alert=True)
             return

         # –†–∞—Å—á—ë—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
         duration_min = usage.voice_duration_seconds / 60
         quality_time = duration_min * 0.6  # RTF 0.6x –¥–ª—è medium
         paid_cost = duration_min * settings.retranscribe_paid_cost_per_minute

         # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞
         keyboard = InlineKeyboardMarkup([
             [InlineKeyboardButton(
                 f"–î–æ–ª—å—à–µ (~{int(quality_time)}—Å)",
                 callback_data=encode_callback_data("retranscribe", usage_id, method="quality")
             )],
             [InlineKeyboardButton(
                 f"–ë—ã—Å—Ç—Ä–æ, –Ω–æ –ø–ª–∞—Ç–Ω–æ (~{paid_cost:.1f}‚ÇΩ)",
                 callback_data=encode_callback_data("retranscribe", usage_id, method="paid")
             )],
             [InlineKeyboardButton(
                 "‚ùå –û—Ç–º–µ–Ω–∞",
                 callback_data="noop"
             )]
         ])

         await query.edit_message_reply_markup(reply_markup=keyboard)

     async def handle_retranscribe(self, update: Update, context):
         """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é."""
         query = update.callback_query
         data = decode_callback_data(query.data)

         usage_id = data['usage_id']
         method = data['method']  # "quality" or "paid"

         usage = await usage_repo.get_by_id(usage_id)

         # –û—Ç–ø—Ä–∞–≤–∏—Ç—å "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é..." –≤ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
         status_msg = await context.bot.send_message(
             chat_id=query.message.chat_id,
             text="üîÑ –ó–∞–ø—É—Å–∫–∞—é –ø–æ–≤—Ç–æ—Ä–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é...",
             reply_to_message_id=query.message.message_id
         )

         # –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
         if method == "quality":
             # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å medium –º–æ–¥–µ–ª—å (—É–∂–µ –¥–µ—Ñ–æ–ª—Ç)
             result = await transcription_router.transcribe(
                 Path(usage.original_file_path),
                 context=TranscriptionContext(...)
             )
         else:  # paid
             # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OpenAI API
             # TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Whisper API
             # –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞
             await status_msg.edit_text("üí∞ –ü–ª–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
             return

         # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Usage record
         new_usage = await usage_repo.create(
             user_id=usage.user_id,
             voice_file_id=usage.voice_file_id + "_retranscribed",
             voice_duration_seconds=usage.voice_duration_seconds,
             model_size=result.model_name,
             processing_time_seconds=result.processing_time,
             transcription_length=len(result.text),
             original_file_path=usage.original_file_path  # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª
         )

         # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
         await variant_repo.save_variant(
             new_usage.id, "original", result.text, generated_by="transcription"
         )

         # –°–æ–∑–¥–∞—Ç—å state –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
         keyboard = create_transcription_keyboard(new_state, ...)

         await status_msg.delete()

         # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
         message_id, file_message_id = await send_transcription_result(
             chat_id=query.message.chat_id,
             user_message_id=query.message.message_id,
             text=result.text,
             keyboard=keyboard,
             usage_id=new_usage.id
         )

         # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π state
         await state_repo.create(
             usage_id=new_usage.id,
             message_id=message_id,
             chat_id=query.message.chat_id,
             is_file_message=(file_message_id is not None),
             file_message_id=file_message_id
         )

         # –í–µ—Ä–Ω—É—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
         original_state = await state_repo.get_by_usage_id(usage_id)
         original_keyboard = create_transcription_keyboard(original_state, ...)
         await query.edit_message_reply_markup(reply_markup=original_keyboard)
     ```

5. **Cleanup —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤** (2 —á–∞—Å–∞)
   - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ TTL:
     ```python
     # –í src/storage/repositories.py
     class UsageRepository:
         async def cleanup_old_audio_files(self, ttl_days: int) -> int:
             """–£–¥–∞–ª–∏—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ TTL."""
             cutoff_date = datetime.utcnow() - timedelta(days=ttl_days)

             old_usages = await self.session.execute(
                 select(Usage).where(
                     Usage.created_at < cutoff_date,
                     Usage.original_file_path.isnot(None)
                 )
             )

             count = 0
             for usage in old_usages.scalars():
                 if usage.original_file_path:
                     try:
                         Path(usage.original_file_path).unlink(missing_ok=True)
                         usage.original_file_path = None
                         count += 1
                     except Exception as e:
                         logger.error(f"Failed to delete file {usage.original_file_path}: {e}")

             await self.session.commit()
             return count
     ```
   - [ ] –ó–∞–ø—É—Å–∫–∞—Ç—å cleanup –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ –¥–µ–Ω—å —á–µ—Ä–µ–∑ asyncio task)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –§–∞–∑—ã 8:**
- ‚úÖ –ê—É–¥–∏–æ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `./data/audio_files/`
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "‚ö° –ú–æ–≥—É –ª—É—á—à–µ" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥–º–µ–Ω—é —Å –¥–≤—É–º—è –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
- ‚úÖ "–î–æ–ª—å—à–µ" –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —Å medium –º–æ–¥–µ–ª—å—é –≤ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–≤–æ–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
- ‚úÖ –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ TTL –¥–Ω–µ–π

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ ./data/audio_files/

# 2. –ù–∞–∂–∞—Ç—å "‚ö° –ú–æ–≥—É –ª—É—á—à–µ"
# –û–∂–∏–¥–∞–Ω–∏–µ: –ü–æ–¥–º–µ–Ω—é —Å —Ä–∞—Å—á—ë—Ç–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

# 3. –í—ã–±—Ä–∞—Ç—å "–î–æ–ª—å—à–µ"
# –û–∂–∏–¥–∞–Ω–∏–µ: –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º, —Å–≤–æ–∏ –∫–Ω–æ–ø–∫–∏

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 8 –¥–Ω–µ–π
# –û–∂–∏–¥–∞–Ω–∏–µ: –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã
```

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –û–±—â–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:**
- ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã (97 unit tests) –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –ö–æ–¥ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: mypy, ruff, black
- ‚úÖ Feature flags –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–∫–ª—é—á–∞—é—Ç/–≤—ã–∫–ª—é—á–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Ç–µ–∫—É—â–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:**
- ‚úÖ –í—Å–µ 6 —Ä—è–¥–æ–≤ –∫–Ω–æ–ø–æ–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–µ–Ω—è—é—Ç—Å—è
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–≥–Ω–æ–≤–µ–Ω–Ω—ã)
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª—ã
- ‚úÖ –¢–∞–π–º–∫–æ–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∞—É–¥–∏–æ

**UX –∫—Ä–∏—Ç–µ—Ä–∏–∏:**
- ‚úÖ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ callback <2 —Å–µ–∫—É–Ω–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –∫—ç—à–µ)
- ‚úÖ LLM –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ 5-10 —Å–µ–∫—É–Ω–¥
- ‚úÖ Inline –∫–Ω–æ–ø–∫–∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—Å–º–∞–π–ª–∏–∫–∏-—Å—Ç–∞—Ç—É—Å—ã) –Ω–µ —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–∞ –∫–ª–∏–∫–∏
- ‚úÖ –ü—Ä–∏ –≥—Ä–∞–Ω–∏—Ü–∞—Ö (shorter/longer) –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –ë–î –∑–∞–ø—Ä–æ—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (–∏–Ω–¥–µ–∫—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
- ‚úÖ Cleanup —Å—Ç–∞—Ä—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ù–µ –±–æ–ª–µ–µ 10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤ –∫—ç—à–µ

---

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫

**–†–∏—Å–∫ 1: –ö–∞—á–µ—Å—Ç–≤–æ LLM –ø—Ä–æ–º–ø—Ç–æ–≤**
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–º–ø—Ç—ã –º–æ–≥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –Ω–∞ –∫–∞–∂–¥–æ–π —Ñ–∞–∑–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  - –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ç—é–Ω–∏–Ω–≥
  - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ feature flags

**–†–∏—Å–∫ 2: –°—Ç–æ–∏–º–æ—Å—Ç—å LLM**
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ = –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
  - –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
  - –õ–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞—Ç—Ä–∞—Ç

### –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫

**–†–∏—Å–∫ 3: Callback data limit (64 –±–∞–π—Ç–∞)**
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
  - –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å–æ–∫—Ä–∞—â–µ–Ω–∏—è, base64)
  - –•—Ä–∞–Ω–∏—Ç—å usage_id, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±—Ä–∞—Ç—å –∏–∑ state –≤ –ë–î

**–†–∏—Å–∫ 4: –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏**
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –£–¥–∞–ª–µ–Ω–∏–µ/–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Telegram API
  - Retry –ª–æ–≥–∏–∫–∞
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏

### –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫

**–†–∏—Å–∫ 5: –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î**
- **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ
  - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ CI (—É–∂–µ –µ—Å—Ç—å)
  - Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–ü–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∞:**

1. **–°–æ–∑–¥–∞—Ç—å feature branch:**
   ```bash
   git checkout main
   git pull origin main
   git checkout -b feature/interactive-transcription
   ```

2. **–ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1:**
   - –°–ª–µ–¥–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–º —à–∞–≥–∞–º –∏–∑ –ø–ª–∞–Ω–∞
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥
   - –ö–æ–º–º–∏—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ–≥—É–ª—è—Ä–Ω–æ

3. **–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã:**
   - –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
   - –°–æ–∑–¥–∞–≤–∞—Ç—å PR –¥–ª—è —Ä–µ–≤—å—é (–∏–ª–∏ –º–µ—Ä–∂–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –µ—Å–ª–∏ solo)
   - –û–±–Ω–æ–≤–ª—è—Ç—å Memory Bank (activeContext.md, progress.md)
   - –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ

4. **–§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–ø–æ—Å–ª–µ –§–∞–∑—ã 8):**
   - –ü–æ–ª–Ω–æ–µ end-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (.env.example, README)
   - Production deployment

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤ (–¥–µ—Ç–∞–ª—å–Ω–æ)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (default):**
```
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (—Å—ã—Ä–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è):
{text}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏ –æ–ø–µ—á–∞—Ç–∫–∏
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é (—Ç–æ—á–∫–∏, –∑–∞–ø—è—Ç—ã–µ, –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ/–≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏)
3. –†–∞–∑–±–∏—Ç—å –Ω–∞ –∞–±–∑–∞—Ü—ã –ø–æ —Å–º—ã—Å–ª—É (–∫–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –º—ã—Å–ª—å - –Ω–æ–≤—ã–π –∞–±–∑–∞—Ü)
4. –í—ã–¥–µ–ª–∏—Ç—å —Å–ø–∏—Å–∫–∏ –±—É–ª–ª–µ—Ç–∞–º–∏ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ (—Å–∏–º–≤–æ–ª ‚Ä¢)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å—å —Å–º—ã—Å–ª –∏ –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
6. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è, —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
7. –ù–ï —Å–æ–∫—Ä–∞—â–∞—Ç—å —Ç–µ–∫—Å—Ç (—ç—Ç–æ –Ω–µ —Ä–µ–∑—é–º–µ, –∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)
8. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∏–ª—å —Ä–µ—á–∏ (–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π/—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π)

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
```

**–†–µ–∑—é–º–µ (default):**
```
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç–µ–∫—Å—Ç–∞, –æ—Ç–≤–µ—á–∞—è –Ω–∞ –≤–æ–ø—Ä–æ—Å "–û —á–µ–º —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç?"

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:
{text}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –í—ã–¥–µ–ª–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Ç–µ–º—É/–∏–¥–µ—é –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º
2. –ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã (3-5 –ø—É–Ω–∫—Ç–æ–≤ –±—É–ª–ª–µ—Ç–∞–º–∏)
3. –û–±—ä—ë–º —Ä–µ–∑—é–º–µ: –ø—Ä–∏–º–µ—Ä–Ω–æ 25-30% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   - –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: "–û —á–µ–º —Ç–µ–∫—Å—Ç: <–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–º—ã>"
   - –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
   - "–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:"
   - –ë—É–ª–ª–µ—Ç—ã (‚Ä¢) —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –ø—É–Ω–∫—Ç–∞–º–∏
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏ —Ñ–∞–∫—Ç—ã
6. –ù–ï –≤—ã–¥—É–º—ã–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–û —á–µ–º —Ç–µ–∫—Å—Ç: <–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ>

–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:
‚Ä¢ <–ø—É–Ω–∫—Ç 1>
‚Ä¢ <–ø—É–Ω–∫—Ç 2>
‚Ä¢ <–ø—É–Ω–∫—Ç 3>

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ä–µ–∑—é–º–µ –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ callback_data

**–§–æ—Ä–º–∞—Ç:** `action:usage_id[:param1=val1,param2=val2]`

**–ü—Ä–∏–º–µ—Ä—ã:**
- `mode:123:mode=original` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
- `mode:123:mode=structured` - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
- `length:123:direction=shorter` - —Å–¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—á–µ
- `emoji:123:direction=increase` - –¥–æ–±–∞–≤–∏—Ç—å —Å–º–∞–π–ª–æ–≤
- `timestamps:123` - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–∫–æ–¥—ã
- `retranscribe_menu:123` - –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Ä–µ—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
- `retranscribe:123:method=quality` - –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é

**–ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
def encode_callback_data(action: str, usage_id: int, **params) -> str:
    parts = [action, str(usage_id)]
    if params:
        param_str = ",".join(f"{k}={v}" for k, v in params.items())
        parts.append(param_str)

    result = ":".join(parts)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    if len(result.encode('utf-8')) > 64:
        raise ValueError(f"Callback data too long: {len(result)} bytes")

    return result

def decode_callback_data(data: str) -> dict:
    parts = data.split(":")
    result = {
        "action": parts[0],
        "usage_id": int(parts[1])
    }

    if len(parts) > 2:
        for param in parts[2].split(","):
            key, value = param.split("=")
            result[key] = value

    return result
```

---

**–ö–æ–Ω–µ—Ü –ø–ª–∞–Ω–∞. –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.**
