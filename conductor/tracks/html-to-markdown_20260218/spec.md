# Specification: Переход форматирования с HTML на MarkdownV2

**Track ID:** html-to-markdown_20260218
**Type:** Bug
**Created:** 2026-02-18
**Status:** Draft

## Summary

При скачивании файлов (MD, TXT) пользователь получает текст с HTML-тегами вместо корректного форматирования. Причина — LLM-промпты генерируют HTML-разметку для Telegram, а ExportService ожидает Markdown. Решение: перевести всю систему форматирования с HTML на MarkdownV2.

## Context

Бот использует LLM (DeepSeek V3) для обработки транскрипций. Промпты явно инструктируют модель использовать HTML-теги (`<b>`, `<i>`, `<code>`, `<u>`, `<a>`), а текст отправляется в Telegram с `parse_mode="HTML"`. ExportService при этом написан в расчёте на Markdown-разметку (`**bold**`, `*italic*`).

PR ветки `feature/download-formats` ещё не вмержен в main — разработка продолжается в текущей ветке.

## Problem Description

**Проблема 1 — MD-экспорт:** При скачивании Markdown-файла пользователь получает текст с HTML-тегами (`<b>текст</b>`) вместо Markdown-разметки (`**текст**`).

**Проблема 2 — TXT-экспорт:** При скачивании текстового файла HTML-теги не удаляются, пользователь видит `<b>текст</b>` вместо чистого текста. Эмодзи, если они присутствовали в исходном тексте, должны сохраняться.

**Шаги воспроизведения:**
1. Отправить боту голосовое сообщение
2. Нажать кнопку "Структурировать" или "Сделать красиво"
3. Нажать кнопку "Скачать" → выбрать формат MD или TXT
4. Открыть скачанный файл — видны HTML-теги вместо корректного форматирования

## Acceptance Criteria

- [ ] LLM-промпты используют Markdown-разметку вместо HTML-тегов
- [ ] Telegram-сообщения отправляются с `parse_mode="MarkdownV2"` и корректно отображаются
- [ ] MD-экспорт содержит валидную Markdown-разметку (без HTML-тегов)
- [ ] TXT-экспорт содержит чистый текст без форматирования, с сохранением эмодзи (если они были в тексте)
- [ ] PDF-экспорт корректно рендерит форматирование (Markdown → HTML → PDF)
- [ ] DOCX-экспорт корректно применяет форматирование из Markdown
- [ ] Все существующие тесты проходят
- [ ] Новые тесты покрывают MarkdownV2-экранирование и конвертацию форматов

## Dependencies

- Ветка `feature/download-formats` (текущая, PR не вмержен)
- Трек `download-formats_20260217` (завершён, база для этого фикса)

## Out of Scope

- БД и логика кэширования вариантов — не меняется
- Логика транскрипции (Whisper) — не затрагивается
- Миграция старых закэшированных в БД вариантов с HTML на Markdown
- Добавление новых форматов экспорта

## Technical Notes

### Затрагиваемые промпты (6 файлов)
- `prompts/structured.md` — секция "Форматирование" с HTML-тегами
- `prompts/magic.md` — инструкции по HTML-форматированию
- `prompts/summary.md` — инструкции по HTML-форматированию
- `prompts/refinement.md` — копия structured.md
- `prompts/length_shorter.md` — "Сохранить HTML-форматирование"
- `prompts/length_longer.md` — "Сохранить HTML-форматирование"

### Затрагиваемые модули
- `src/bot/callbacks.py` — 10+ вызовов `parse_mode="HTML"` и `sanitize_html()`
- `src/bot/handlers.py` — 3 вызова `parse_mode="HTML"`
- `src/services/text_processor.py` — 5 вызовов `sanitize_html()`
- `src/services/transcription_orchestrator.py` — вызовы `sanitize_html()` и `escape_html()`
- `src/utils/html_utils.py` — замена на `markdown_utils.py`
- `src/services/pdf_generator.py` — нужна конвертация Markdown → HTML для WeasyPrint
- `src/services/export_service.py` — уже работает с Markdown, но нужна проверка

### MarkdownV2 спецсимволы (требуют экранирования)
```
_ * [ ] ( ) ~ ` > # + - = | { } . !
```

---

_Generated by Conductor. Review and edit as needed._
