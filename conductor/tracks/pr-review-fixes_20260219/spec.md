# Specification: PR Review Fixes for download-formats & html-to-markdown

**Track ID:** pr-review-fixes_20260219
**Type:** Refactor
**Created:** 2026-02-19
**Status:** Draft

## Summary

Исправление всех 21 issue, выявленных при комплексном ревью PR #111 (feature/download-formats). Включает critical баги, улучшение обработки ошибок, обновление устаревших комментариев, добавление недостающих тестов и исправление нарушений архитектурных паттернов.

## Context

PR #111 объединяет два трека: download-formats_20260217 (экспорт транскрипций в MD/TXT/PDF/DOCX) и html-to-markdown_20260218 (миграция форматирования с HTML на MarkdownV2). Ревью выявило проблемы в обработке ошибок, устаревшие комментарии после миграции, недостающие тесты error paths и нарушения DI-паттерна.

## Acceptance Criteria

- [ ] Все 5 critical issues исправлены (fallback-промпт, двойная конвертация PDF, пустые catch-блоки, обработка ошибок ExportService, разделение try-блоков)
- [ ] Все 8 important issues исправлены (двойной query.answer, DI для ExportService, логирование, fallback PDF->TXT, устаревшие комментарии, assert, тесты маршрутизации, тесты error paths)
- [ ] Все 8 suggestions адресованы (имена настроек в тестах, docstrings, None-защита, BytesIO cleanup, дублирование хелперов, exc_info, вложенный markdown тест)
- [ ] Все существующие + новые тесты проходят
- [ ] ruff, black, mypy без ошибок

## Dependencies

- PR #111 (feature/download-formats branch) — изменения вносятся в ту же ветку

## Out of Scope

- Очистка "Phase N" комментариев по всему проекту (отдельный chore-трек)
- Пустые catch-блоки в orchestrator.py, существовавшие до PR #111 (MEDIUM-5)
- Новая функциональность

## Technical Notes

- Изменения затрагивают: callbacks.py, export_service.py, pdf_generator.py, text_processor.py, markdown_utils.py, keyboards.py, config.py
- Тестовые файлы: test_callbacks.py, test_callbacks_download.py, test_export_service.py, test_markdown_utils.py, test_pdf_generator.py
- Баг двойной конвертации в `generate_pdf_from_text` требует пересмотра логики метода
- ExportService нуждается в кастомном ExportError из exceptions.py

---

_Generated by Conductor. Review and edit as needed._
